<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rajasthan SandStone Hub - Bijoliya & Rajasthan Natural Stones</title>
<meta name="description" content="Explore Rajasthan's best sandstone varieties from Bijoliya and nearby regions. Connect directly with verified suppliers and factories.">

<style>
/* ===== Reset & Basics ===== */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Arial,sans-serif;background:#fafafa;color:#333;}

/* ===== Header ===== */
header{
  background:#c49a6c;
  color:#fff;
  text-align:center;
  padding:20px 10px;
  box-shadow:0 2px 5px rgba(0,0,0,0.15);
}
header h1{font-size:1.8em;}
header p{font-size:0.9em;margin-top:5px;}

/* ===== Navbar ===== */
nav{
  background:#fff;
  display:flex;
  justify-content:center;
  flex-wrap:wrap;
  border-bottom:2px solid #e0e0e0;
}
nav a{
  text-decoration:none;
  color:#333;
  padding:12px 16px;
  display:block;
  font-weight:600;
  transition:0.3s;
}
nav a:hover{background:#c49a6c;color:#fff;}

/* ===== Hero Section ===== */
.hero{
  background:url('https://images.unsplash.com/photo-1581091870623-8c6b3d14f4b5?auto=format&fit=crop&w=1400&q=70') no-repeat center/cover;
  height:300px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  text-shadow:1px 1px 3px rgba(0,0,0,0.6);
  font-size:1.8em;
  text-align:center;
  padding:10px;
}

/* ===== Section General ===== */
section{
  max-width:1100px;
  margin:40px auto;
  padding:20px;
  background:#fff;
  border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

/* ===== Product Grid ===== */
.products{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:20px;
  margin-top:20px;
}
.product{
  background:#fff;
  border:1px solid #ddd;
  border-radius:10px;
  overflow:hidden;
  transition:transform 0.3s, box-shadow 0.3s;
}
.product:hover{
  transform:translateY(-5px);
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
}
.product img{
  width:100%;
  height:180px;
  object-fit:cover;
}
.product .info{
  padding:10px 15px;
}
.product .info h3{
  color:#c49a6c;
  margin-bottom:8px;
}
.product .info p{
  font-size:0.9em;
  color:#555;
}

/* ===== Admin Form ===== */
#adminForm{
  max-width:500px;
  margin:40px auto;
  background:#fff;
  padding:20px;
  border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
#adminForm input, #adminForm textarea, #adminForm select{
  width:100%;
  padding:10px;
  margin:10px 0;
  border:1px solid #ccc;
  border-radius:6px;
}
#adminForm button{
  background:#c49a6c;
  color:#fff;
  padding:10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  width:100%;
  font-size:1em;
  font-weight:600;
}
#adminForm button:hover{
  background:#b35f4a;
}

/* ===== Message Styles ===== */
#msg{
  margin:10px 0;
  padding:10px;
  border-radius:5px;
  text-align:center;
  font-weight:600;
}

/* ===== Footer ===== */
footer{
  background:#333;
  color:#fff;
  text-align:center;
  padding:15px 5px;
  font-size:0.9em;
  margin-top:40px;
}

/* ===== Responsive ===== */
@media(max-width:700px){
  nav a{padding:10px;font-size:0.9em;}
  .hero{font-size:1.3em;height:200px;}
  section{padding:15px;margin:20px auto;}
}
</style>
</head>
<body>

<header>
  <h1>Rajasthan SandStone Hub</h1>
  <p>Your Trusted Source for Bijoliya & Rajasthan Natural Stones</p>
</header>

<nav>
  <a href="index.html">Home</a>
  <a href="#products">Products</a>
  <a href="#adminForm">Add Product</a>
  <a href="about.html">About</a>
  <a href="contact.html">Contact</a>
  <a href="privacy.html">Privacy</a>
  <a href="terms.html">Terms</a>
</nav>

<div class="hero">
  Rajasthan's Finest Stone Collection
</div>

<section id="products">
  <h2>Explore Our Stone Categories</h2>
  <p>Browse premium stones from Bijoliya and across Rajasthan ‚Äî including Sandstone, Marble, Granite, Kota Stone, and more.</p>
  <div id="categoryContainer" class="products">
    <p style="text-align:center;color:#666;">Loading products...</p>
  </div>
</section>

<!-- ===== Admin Product Add Form ===== -->
<section id="adminForm">
  <h2>Add New Product</h2>
  <form id="productForm">
    <input type="text" id="name" placeholder="Stone Name" required>
    <input type="text" id="factory" placeholder="Factory Name" required>
    <input type="text" id="mainCategory" placeholder="Main Category (e.g. Sandstone, Marble)" required>
    <input type="text" id="subCategory" placeholder="Sub Category (e.g. Brown, Red, White)" required>
    <input type="number" id="price" placeholder="Price ‚Çπ" required>
    <input type="text" id="contact" placeholder="Contact Number" required>
    <textarea id="description" placeholder="Description" rows="3"></textarea>
    <input type="file" id="imageFile" accept="image/*" required>
    <button type="submit">Add Product</button>
    <p id="msg"></p>
  </form>
</section>

<footer>
  ¬© 2025 Rajasthan SandStone Hub | Designed by RJ Services
</footer>

<!-- ‚úÖ Updated Firebase Integration with Better Error Handling -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

  // ‚úÖ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDxNMhU09mINvq_aDLtylBg3FucCK-MzYE",
    authDomain: "sandstonebijoliya-293d2.firebaseapp.com",
    projectId: "sandstonebijoliya-293d2",
    storageBucket: "sandstonebijoliya-293d2.appspot.com",
    messagingSenderId: "133756247845",
    appId: "1:133756247845:web:8e769ce2af3db1765484cc",
    measurementId: "G-H7JMX9VNYF"
  };

  // Initialize Firebase
  let db, storage;
  try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    storage = getStorage(app);
    console.log("‚úÖ Firebase initialized successfully");
  } catch (error) {
    console.error("‚ùå Firebase initialization error:", error);
    showMessage("Firebase initialization failed: " + error.message, "error");
  }

  const msg = document.getElementById("msg");

  // Message display function
  function showMessage(message, type = "info") {
    msg.textContent = message;
    msg.style.color = type === "error" ? "red" : type === "success" ? "green" : "blue";
    msg.style.backgroundColor = type === "error" ? "#ffe6e6" : type === "success" ? "#e6ffe6" : "#e6f3ff";
    msg.style.border = type === "error" ? "1px solid red" : type === "success" ? "1px solid green" : "1px solid blue";
  }

  // ===== Load Products =====
  async function loadProducts() {
    try {
      const container = document.getElementById("categoryContainer");
      container.innerHTML = "<p style='text-align:center;color:#666;'>Loading products...</p>";

      // Get all categories
      const categoriesSnap = await getDocs(collection(db, "stones"));
      
      if (categoriesSnap.empty) {
        container.innerHTML = "<p style='text-align:center;color:#666;'>No products found. Add some products using the form below.</p>";
        return;
      }

      container.innerHTML = "";
      
      // Loop through each category
      for (const catDoc of categoriesSnap.docs) {
        const categoryId = catDoc.id;
        
        // Create category heading
        const catDiv = document.createElement("div");
        catDiv.style.gridColumn = "1 / -1";
        catDiv.style.marginTop = "30px";
        catDiv.style.marginBottom = "10px";
        catDiv.innerHTML = `<h2 style="color:#c49a6c; border-bottom:2px solid #c49a6c; padding-bottom:5px;">${categoryId.toUpperCase()}</h2>`;
        container.appendChild(catDiv);

        // Get subcategories for this category
        const subSnap = await getDocs(collection(db, `stones/${categoryId}/subcategories`));
        
        for (const subDoc of subSnap.docs) {
          const subId = subDoc.id;
          
          // Create subcategory heading
          const subDiv = document.createElement("div");
          subDiv.style.gridColumn = "1 / -1";
          subDiv.innerHTML = `<h3 style="margin:15px 0 10px 0; color:#333; font-size:1.2em;">${subId}</h3>`;
          container.appendChild(subDiv);

          // Get products for this subcategory
          const productsSnap = await getDocs(collection(db, `stones/${categoryId}/subcategories/${subId}/products`));
          
          const grid = document.createElement("div");
          grid.className = "products";
          grid.style.gridColumn = "1 / -1";
          
          if (productsSnap.empty) {
            grid.innerHTML = "<p style='text-align:center;color:#999;'>No products in this category yet.</p>";
          } else {
            productsSnap.forEach(productDoc => {
              const productData = productDoc.data();
              const div = document.createElement("div");
              div.className = "product";
              div.innerHTML = `
                <img src="${productData.imageURL || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="${productData.name}" onerror="this.src='https://via.placeholder.com/300x200?text=Image+Error'">
                <div class="info">
                  <h3>${productData.name || 'Unnamed Product'}</h3>
                  <p>${productData.description || 'No description available.'}</p>
                  <p><b>‚Çπ${productData.price || 'N/A'}</b> | ${productData.factory || 'Unknown Factory'}</p>
                  <p>üìû ${productData.contact || 'Contact not provided'}</p>
                </div>
              `;
              grid.appendChild(div);
            });
          }
          container.appendChild(grid);
        }
      }

      // If no products were actually displayed
      if (container.innerHTML === "") {
        container.innerHTML = "<p style='text-align:center;color:#666;'>No products available. Add some products using the form below.</p>";
      }

    } catch (error) {
      console.error("Error loading products:", error);
      const container = document.getElementById("categoryContainer");
      container.innerHTML = `
        <div style="text-align:center; color:red; background:#ffe6e6; padding:20px; border-radius:5px; grid-column:1/-1;">
          <p><strong>Error loading products:</strong></p>
          <p>${error.message}</p>
          <p>Please check console for details and make sure Firebase is properly configured.</p>
        </div>
      `;
    }
  }

  // ===== Add Product =====
  document.getElementById("productForm").addEventListener("submit", async e => {
    e.preventDefault();
    showMessage("‚è≥ Uploading product...", "info");

    const name = document.getElementById("name").value;
    const factory = document.getElementById("factory").value;
    const mainCategory = document.getElementById("mainCategory").value.trim().toLowerCase();
    const subCategory = document.getElementById("subCategory").value.trim().toLowerCase();
    const price = document.getElementById("price").value;
    const contact = document.getElementById("contact").value;
    const description = document.getElementById("description").value;
    const image = document.getElementById("imageFile").files[0];

    // Validation
    if (!image) {
      showMessage("‚ùå Please select an image file", "error");
      return;
    }

    if (!name || !factory || !mainCategory || !subCategory || !price || !contact) {
      showMessage("‚ùå Please fill all required fields", "error");
      return;
    }

    try {
      console.log("Starting upload process...");

      // 1. Upload image to Firebase Storage
      const imageRef = ref(storage, `stoneImages/${Date.now()}_${image.name}`);
      console.log("Uploading image to storage...");
      
      const uploadResult = await uploadBytes(imageRef, image);
      console.log("Image uploaded successfully:", uploadResult);
      
      const imageURL = await getDownloadURL(imageRef);
      console.log("Image URL:", imageURL);

      // 2. Prepare product data
      const productData = {
        name: name,
        factory: factory,
        price: parseInt(price),
        contact: contact,
        description: description,
        imageURL: imageURL,
        createdAt: new Date().toISOString(),
        category: mainCategory,
        subCategory: subCategory
      };

      console.log("Product data prepared:", productData);

      // 3. Ensure category and subcategory documents exist
      const categoryRef = doc(db, "stones", mainCategory);
      const subcategoryRef = doc(db, `stones/${mainCategory}/subcategories`, subCategory);
      
      // We'll just try to add the product directly - Firestore will create paths automatically
      
      // 4. Add product to Firestore
      console.log("Adding product to Firestore...");
      const productsCollectionRef = collection(db, `stones/${mainCategory}/subcategories/${subCategory}/products`);
      await addDoc(productsCollectionRef, productData);
      
      console.log("‚úÖ Product added successfully!");

      // 5. Show success message
      showMessage("‚úÖ Product added successfully! Reloading products...", "success");
      
      // 6. Reset form
      document.getElementById("productForm").reset();
      
      // 7. Reload products after a short delay
      setTimeout(() => {
        loadProducts();
      }, 1000);

    } catch (error) {
      console.error("‚ùå Error adding product:", error);
      showMessage("‚ùå Error: " + error.message, "error");
    }
  });

  // ===== Test Firebase Connection =====
  async function testFirebaseConnection() {
    try {
      console.log("Testing Firebase connection...");
      
      // Test Firestore
      const testCollection = collection(db, "connection_test");
      await addDoc(testCollection, {
        test: true,
        timestamp: new Date().toISOString()
      });
      console.log("‚úÖ Firestore connection test passed");
      
      // Test Storage with a small file
      const testBlob = new Blob(["firebase connection test"], { type: "text/plain" });
      const testStorageRef = ref(storage, `connection_test/test_${Date.now()}.txt`);
      await uploadBytes(testStorageRef, testBlob);
      console.log("‚úÖ Storage connection test passed");
      
      return true;
    } catch (error) {
      console.error("‚ùå Firebase connection test failed:", error);
      return false;
    }
  }

  // ===== Initialize App =====
  window.addEventListener('DOMContentLoaded', async () => {
    console.log("Initializing Rajasthan SandStone Hub...");
    
    // Test Firebase connection
    const isConnected = await testFirebaseConnection();
    if (isConnected) {
      console.log("‚úÖ All Firebase services connected successfully");
      showMessage("‚úÖ System ready - You can now add products", "success");
    } else {
      console.log("‚ùå Firebase connection issues detected");
      showMessage("‚ö†Ô∏è System connection issues - Some features may not work", "error");
    }
    
    // Load existing products
    loadProducts();
  });

  // Global error handler for image loading
  window.addEventListener('error', function(e) {
    if (e.target.tagName === 'IMG') {
      e.target.src = 'https://via.placeholder.com/300x200?text=Image+Error';
    }
  }, true);
</script>

</body>
</html>
