<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rajasthan SandStone Hub - Live Products</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  body { font-family: 'Poppins', sans-serif; background:#f9f9f9; }
  header { background:#c45e00; color:#fff; padding:14px; text-align:center; font-weight:700; }
  .card-img { height:200px; object-fit:cover; border-radius:0.5rem; }
  .tag-title { display:inline-block; padding:4px 8px; border-radius:6px; background:#f3f4f6; color:#111; font-weight:600; }
  .field-title { color:#c45e00; font-weight:700; }
  .btn { padding:6px 10px; border-radius:6px; cursor:pointer; }
  .btn-edit { background:#2563eb; color:#fff; }
  .btn-delete { background:#ef4444; color:#fff; }
  .modal-bg { background: rgba(0,0,0,0.5); position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:50; }
  .modal { background:#fff; padding:16px; border-radius:8px; width:320px; max-width:90%; }
</style>
</head>
<body>

<header>ü™® Rajasthan SandStone Hub - Live Products</header>

<div class="max-w-6xl mx-auto px-4 py-4">
  <!-- Filters -->
  <div class="flex flex-wrap gap-3 mb-4 items-center">
    <input id="searchInput" class="border p-2 rounded flex-1" placeholder="üîç Search by any field..." />
    <select id="categoryFilter" class="border p-2 rounded"></select>
    <select id="subCategoryFilter" class="border p-2 rounded"></select>
    <select id="companyFilter" class="border p-2 rounded"></select>
    <select id="rateSort" class="border p-2 rounded">
      <option value="">Sort by Rate</option>
      <option value="low-high">Lowest ‚Üí Highest</option>
      <option value="high-low">Highest ‚Üí Lowest</option>
    </select>
  </div>

  <!-- Products grid -->
  <div id="products" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
    ‚è≥ Loading...
  </div>
</div>

<footer class="text-center py-4 text-sm text-white" style="background:#111">¬© 2025 Rajasthan SandStone Hub</footer>

<!-- Edit / Delete Modal -->
<div id="modal" style="display:none" class="modal-bg">
  <div class="modal">
    <h3 id="modalTitle" class="font-bold mb-2">Enter Security Code</h3>
    <input id="modalCode" class="border p-2 rounded w-full mb-2" placeholder="Security code" />
    <div class="text-xs text-gray-500 mb-2">This code is stored securely in sheet and not shown on site.</div>
    <div class="flex gap-2 justify-end">
      <button id="modalCancel" class="btn">Cancel</button>
      <button id="modalConfirm" class="btn btn-edit">Confirm</button>
    </div>
    <div id="modalMsg" class="text-sm mt-2"></div>
  </div>
</div>

<script>
/* === CONFIG === */
const SHEET_ID = "1ob32T2NWQVZnxC07hBHT9neCEFFBP3neq0S30zV9-1A";
const SHEET_NAME = "Form Responses 1";
const OPEN_SHEET_API = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_NAME}`;
const WEB_APP_URL = "https://script.google.com/macros/s/NEW_DEPLOYMENT_ID/exec"; // ‚Üê REPLACE with your deployed Apps Script web app URL (doPost endpoint)
const fallbackImage = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAMAAAAoyzS7AAAAA1BMVEX///+nxBvIAAAAAXRSTlMAQObYZgAAAApJREFUGFdjYAAAAAIAAeIhvDMAAAAASUVORK5CYII=";

let productsData = [];


/* ========== Load and render ========== */
async function loadProducts() {
  const container = document.getElementById('products');
  container.innerHTML = '‚è≥ Loading...';
  try {
    const res = await fetch(OPEN_SHEET_API);
    const data = await res.json();
    if (!Array.isArray(data)) { container.innerHTML = '<p>No data</p>'; return; }

    // map and normalize fields ‚Äî column names as you said (trimmed and fallback)
    productsData = data.map((row, index) => {
      // pick possible column name forms
      const get = (names) => names.reduce((acc, k)=> acc || (row[k] ? row[k].toString().trim() : ""), "");
      let img = get(["UPLOAD SAMPLE IMAGE","UPLOAD SAMPLE IMAGE "]) || "";
      if (img.includes("drive.google.com")) {
        const m = img.match(/[-\w]{25,}/);
        if (m) img = `https://lh3.googleusercontent.com/d/${m[0]}=s800`;
      }
      const category = get(["STONE CATAGORY ","STONE CATAGORY"]) || "Unknown";
      const subCategory = get(["STONE SUB CATAGORY ","STONE SUB CATAGORY"]) || "N/A";
      const description = get(["DESCRIPTION ","DESCRIPTION"]) || "";
      const address = get(["ADDRESS"]) || "Not Given";
      const contact = get(["CONTACT ","CONTACT"]) || "";
      const company = get(["Company / Firm Name ","Company / Firm Name"]) || "N/A";
      const rateRaw = get(["RATE ","RATE"]) || "0";
      const rate = parseFloat(rateRaw.replace(/[^\d.-]/g,'')) || 0;
      const rating = get(["RATING ","RATING"]) || "N/A";
      const email = get(["EMAIL","Email","email"]) || "";
      const security = get(["SECURITY CODE","Security Code","SECURITY_CODE"]) || "";
      // keep original row index (sheet row = index+2 because header row)
      return { __row: index + 2, image: img || fallbackImage, category, subCategory, description, address, contact, company, rate, rating, email, security };
    });

    populateFilters();
    renderProducts(productsData);
  } catch (err) {
    console.error(err);
    document.getElementById('products').innerHTML = '<p>Error loading products.</p>';
  }
}

/* ========== Render cards ========== */
function renderProducts(list) {
  const container = document.getElementById('products');
  container.innerHTML = '';
  if (list.length === 0) { container.innerHTML = '<p class="col-span-full">No products found</p>'; return; }

  list.forEach(item => {
    const cleanPhone = (s) => (s || '').replace(/[^+\d]/g,''); // sanitize digits & plus
    const waNumber = cleanPhone(item.contact);
    const waText = encodeURIComponent(`Hello, I am interested in your ${item.category} - ${item.subCategory}`);
    const waLink = waNumber ? `https://wa.me/${waNumber.replace(/^\+/, '')}?text=${waText}` : '#';

    const card = document.createElement('div');
    card.className = 'bg-white p-4 rounded-lg shadow';

    card.innerHTML = `
      <img class="card-img rounded" src="${item.image}" onerror="this.src='${fallbackImage}'" alt="${escapeHtml(item.category)}" />
      <div class="mt-2">
        <div class="flex items-center justify-between">
          <div>
            <div class="field-title">${escapeHtml(item.category)}</div>
            <div class="text-sm text-gray-600"> ${escapeHtml(item.subCategory)}</div>
          </div>
          <div class="text-sm font-semibold text-green-700">‚Çπ ${item.rate}</div>
        </div>

        <p class="mt-2 text-sm">${escapeHtml(item.description)}</p>

        <p class="mt-2 text-sm"><span class="font-semibold">ADDRESS:</span> ${escapeHtml(item.address)}</p>
        <p class="text-sm"><span class="font-semibold">CONTACT:</span> <a class="text-blue-600" href="${waLink}" target="_blank">${escapeHtml(item.contact || '‚Äî')}</a></p>
        <p class="text-sm font-medium mt-1">üè¢ ${escapeHtml(item.company)}</p>
        <p class="text-sm">‚≠ê ${escapeHtml(item.rating)}</p>

        <div class="mt-3 flex gap-2">
          <button class="btn btn-edit px-3 py-1 text-white" data-action="edit" data-row="${item.__row}">Edit</button>
          <button class="btn btn-delete px-3 py-1 text-white" data-action="delete" data-row="${item.__row}">Delete</button>
        </div>
      </div>
    `;
    container.appendChild(card);
  });

  // attach edit/delete handlers
  document.querySelectorAll('[data-action="edit"]').forEach(b => b.addEventListener('click', onEditClick));
  document.querySelectorAll('[data-action="delete"]').forEach(b => b.addEventListener('click', onDeleteClick));
}

/* ========== Filters & Search ========== */
function populateFilters() {
  const cats = [...new Set(productsData.map(p=>p.category))].sort();
  const subs = [...new Set(productsData.map(p=>p.subCategory))].sort();
  const comps = [...new Set(productsData.map(p=>p.company))].sort();

  const setOptions = (elId, list) => {
    const el = document.getElementById(elId);
    el.innerHTML = `<option value="">All ${elId.replace('Filter','')}</option>` + list.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
  };
  setOptions('categoryFilter', cats);
  setOptions('subCategoryFilter', subs);
  setOptions('companyFilter', comps);
}

document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('categoryFilter').addEventListener('change', applyFilters);
document.getElementById('subCategoryFilter').addEventListener('change', applyFilters);
document.getElementById('companyFilter').addEventListener('change', applyFilters);
document.getElementById('rateSort').addEventListener('change', applyFilters);

function applyFilters() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const cat = document.getElementById('categoryFilter').value;
  const sub = document.getElementById('subCategoryFilter').value;
  const comp = document.getElementById('companyFilter').value;
  const sort = document.getElementById('rateSort').value;

  let filtered = productsData.filter(p=>{
    const matchesSearch = q ? Object.values(p).some(v => v && v.toString().toLowerCase().includes(q)) : true;
    const matchesCat = cat ? p.category === cat : true;
    const matchesSub = sub ? p.subCategory === sub : true;
    const matchesComp = comp ? p.company === comp : true;
    return matchesSearch && matchesCat && matchesSub && matchesComp;
  });

  if (sort === 'low-high') filtered.sort((a,b)=>a.rate-b.rate);
  if (sort === 'high-low') filtered.sort((a,b)=>b.rate-a.rate);

  renderProducts(filtered);
}

/* ========== Edit/Delete flow (modal + verify) ========== */
let pendingAction = null; // {type: 'edit'|'delete', row: number}
function onEditClick(ev) { pendingAction = {type:'edit', row: +ev.currentTarget.dataset.row}; openModal('Enter security code to EDIT'); }
function onDeleteClick(ev) { pendingAction = {type:'delete', row: +ev.currentTarget.dataset.row}; openModal('Enter security code to DELETE'); }

function openModal(title) {
  document.getElementById('modalTitle').innerText = title;
  document.getElementById('modalCode').value = '';
  document.getElementById('modalMsg').innerText = '';
  document.getElementById('modal').style.display = 'flex';
}
document.getElementById('modalCancel').onclick = () => document.getElementById('modal').style.display = 'none';
document.getElementById('modalConfirm').onclick = modalConfirm;

async function modalConfirm() {
  const code = document.getElementById('modalCode').value.trim();
  if (!code) { document.getElementById('modalMsg').innerText = 'Please enter security code'; return; }
  document.getElementById('modalMsg').innerText = 'Verifying...';

  // call backend
  try {
    const payload = { action: pendingAction.type, row: pendingAction.row, code };
    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    if (result && result.success) {
      document.getElementById('modalMsg').innerText = 'Success: ' + (result.message || 'Done');
      document.getElementById('modal').style.display = 'none';
      // if edit: open inline edit form provided by backend data (we will fetch updated row)
      if (pendingAction.type === 'edit') {
        // open edit form window (simple prompt for demo) - you can expand to full form UI
        const newDesc = prompt('Enter new DESCRIPTION', result.rowData && result.rowData.description || '');
        if (newDesc !== null) {
          // send update request
          await fetch(WEB_APP_URL, {
            method:'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ action:'applyEdit', row: pendingAction.row, code, updates: { DESCRIPTION: newDesc } })
          });
          alert('Update request sent. Changes should reflect shortly.');
          loadProducts();
        }
      } else if (pendingAction.type === 'delete') {
        alert('Product deleted (or marked deleted).');
        loadProducts();
      }
    } else {
      document.getElementById('modalMsg').innerText = 'Error: ' + (result && result.message ? result.message : 'Verification failed');
      // if blocked, show message
    }
  } catch (err) {
    console.error(err);
    document.getElementById('modalMsg').innerText = 'Server error. Try later.';
  }
}

/* escape helper */
function escapeHtml(s) { return (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* load initial */
loadProducts();

</script>
</body>
</html>
