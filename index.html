<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rajasthan SandStone Hub - Live Products</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
Â  body { font-family: 'Poppins', sans-serif; background:#f9f9f9; }
Â  header { background:#c45e00; color:#fff; padding:14px; text-align:center; font-weight:700; }
Â  .card-img { height:200px; object-fit:cover; border-radius:0.5rem; }
Â  .field-title { color:#c45e00; font-weight:700; }
Â  .btn { padding:6px 10px; border-radius:6px; cursor:pointer; }
Â  .btn-edit { background:#2563eb; color:#fff; }
Â  .btn-delete { background:#ef4444; color:#fff; }
Â  .modal-bg { background: rgba(0,0,0,0.5); position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:50; }
Â  .modal { background:#fff; padding:16px; border-radius:8px; width:320px; max-width:90%; }
</style>
</head>
<body>

<header>ğŸª¨ Rajasthan SandStone Hub - Live Products</header>

<div class="max-w-6xl mx-auto px-4 py-4">
Â  Â  <div class="flex flex-wrap gap-3 mb-4 items-center">
Â  Â  <input id="searchInput" class="border p-2 rounded flex-1" placeholder="ğŸ” Search by any field..." />
Â  Â  <select id="categoryFilter" class="border p-2 rounded"></select>
Â  Â  <select id="subCategoryFilter" class="border p-2 rounded"></select>
Â  Â  <select id="companyFilter" class="border p-2 rounded"></select>
Â  Â  <select id="rateSort" class="border p-2 rounded">
Â  Â  Â  <option value="">Sort by Rate</option>
Â  Â  Â  <option value="low-high">Lowest â†’ Highest</option>
Â  Â  Â  <option value="high-low">Highest â†’ Lowest</option>
Â  Â  </select>
Â  </div>

Â  Â  <div id="products" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
Â  Â  â³ Loading...
Â  </div>
</div>

<footer class="text-center py-4 text-sm text-white" style="background:#111">Â© 2025 Rajasthan SandStone Hub</footer>

<div id="modal" style="display:none" class="modal-bg">
Â  <div class="modal">
Â  Â  <h3 id="modalTitle" class="font-bold mb-2">Enter Security Code</h3>
Â  Â  <input id="modalCode" class="border p-2 rounded w-full mb-2" placeholder="Security code" />
Â  Â  <div class="text-xs text-gray-500 mb-2">This code is stored securely in sheet and not shown on site.</div>
Â  Â  <div class="flex gap-2 justify-end">
Â  Â  Â  <button id="modalCancel" class="btn">Cancel</button>
Â  Â  Â  <button id="modalConfirm" class="btn btn-edit">Confirm</button>
Â  Â  </div>
Â  Â  <div id="modalMsg" class="text-sm mt-2"></div>
Â  </div>
</div>

<script>
const SHEET_ID = "1ob32T2NWQVZnxC07hBHT9neCEFFBP3neq0S30zV9-1A";
const SHEET_NAME = "Form Responses 1";
const OPEN_SHEET_API = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_NAME}`;

// ğŸ›‘ IMPORTANT: Replace this with your newly deployed Apps Script URL
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzSmZBH8wNK3HhfDTzOPD5GVytOBe3MF-_qx8rGakgM09KpZzaIHsNe5bICy8pSDGGh/exec"; 

const fallbackImage = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAMAAAAoyzS7AAAAA1BMVEX///+nxBvIAAAAAXRSTlMAQObYZgAAAApJREFUGFdjYAAAAAIAAeIhvDMAAAAASUVORK5CYII=";

let productsData = [];

// ---------------------- UTILITIES ----------------------
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&','<':'<','>':'>','"':'"',"'":'''}[c])); }

function normalizeDriveImage(url){
Â  if(!url) return fallbackImage;
Â  if(url.includes("lh3.googleusercontent.com")) return url;
Â  const match = url.match(/[-\w]{25,}/);
Â  // ğŸŒŸ FIX: Corrected CDN link structure for client-side normalization
Â  if(match) return `http://googleusercontent.com/profile/picture/${match[0]}=s800`;
Â  return fallbackImage;
}

// ---------------------- LOAD PRODUCTS ----------------------
async function loadProducts(){
Â  const container = document.getElementById('products');
Â  container.innerHTML = 'â³ Loading...';
Â  try{
Â  Â  const res = await fetch(OPEN_SHEET_API);
    if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`); // Added status check
Â  Â  const data = await res.json();
Â  Â  if(!Array.isArray(data)){ container.innerHTML='<p>No data</p>'; return; }

Â  Â  productsData = data.map((row, index) => {
Â  Â  Â  const get = (names) => names.reduce((acc, k)=> acc || (row[k]?row[k].toString().trim():""),"");
Â  Â  Â  return {
Â  Â  Â  Â  __row: index+2,
Â  Â  Â  Â  image: normalizeDriveImage(get(["UPLOAD SAMPLE IMAGE","UPLOAD SAMPLE IMAGE "])),
Â  Â  Â  Â  category: get(["STONE CATAGORY ","STONE CATAGORY"])||"Unknown",
Â  Â  Â  Â  subCategory: get(["STONE SUB CATAGORY ","STONE SUB CATAGORY"])||"N/A",
Â  Â  Â  Â  description: get(["DESCRIPTION ","DESCRIPTION"])||"",
Â  Â  Â  Â  address: get(["ADDRESS"])||"Not Given",
Â  Â  Â  Â  contact: get(["CONTACT ","CONTACT"])||"",
Â  Â  Â  Â  company: get(["Company / Firm Name ","Company / Firm Name"])||"N/A",
Â  Â  Â  Â  rate: parseFloat((get(["RATE ","RATE"])||"0").replace(/[^\d.-]/g,''))||0,
Â  Â  Â  Â  rating: get(["RATING ","RATING"])||"N/A",
Â  Â  Â  Â  email: get(["Â  EmailÂ  ","Email","email"])||"",
Â  Â  Â  Â  security: get(["Â  SECURITY CODEÂ  ","SECURITY CODE","SECURITY_CODE"])||""
Â  Â  Â  };
Â  Â  });

Â  Â  populateFilters();
Â  Â  renderProducts(productsData);
Â  } catch(err){
Â  Â  console.error(err);
Â  Â  container.innerHTML = `<p>Error loading products: ${err.message}</p>`;
Â  }
}

// ---------------------- RENDER PRODUCTS ----------------------
function renderProducts(list){
Â  const container = document.getElementById('products');
Â  container.innerHTML='';
Â  if(!list.length){ container.innerHTML='<p class="col-span-full">No products found</p>'; return; }

Â  list.forEach(item=>{
Â  Â  const cleanPhone = (s)=> (s||'').replace(/[^+\d]/g,'');
Â  Â  const waLink = item.contact ? `https://wa.me/${cleanPhone(item.contact)}?text=${encodeURIComponent('Hello, I am interested in your ' + item.category + ' - ' + item.subCategory)}` : '#';

Â  Â  const card=document.createElement('div');
Â  Â  card.className='bg-white p-4 rounded-lg shadow';
Â  Â  card.innerHTML=`
Â  Â  Â  <img class="card-img" src="${item.image}" onerror="this.src='${fallbackImage}'" alt="${escapeHtml(item.category)}" />
Â  Â  Â  <div class="mt-2">
Â  Â  Â  Â  <div class="flex items-center justify-between">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div class="field-title">${escapeHtml(item.category)}</div>
Â  Â  Â  Â  Â  Â  <div class="text-sm text-gray-600">${escapeHtml(item.subCategory)}</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="text-sm font-semibold text-green-700">â‚¹ ${item.rate}</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <p class="mt-2 text-sm">${escapeHtml(item.description)}</p>
Â  Â  Â  Â  <p class="mt-2 text-sm"><span class="font-semibold">ADDRESS:</span> ${escapeHtml(item.address)}</p>
Â  Â  Â  Â  <p class="text-sm"><span class="font-semibold">CONTACT:</span> <a class="text-blue-600" href="${waLink}" target="_blank">${escapeHtml(item.contact||'â€”')}</a></p>
Â  Â  Â  Â  <p class="text-sm font-medium mt-1">ğŸ¢ ${escapeHtml(item.company)}</p>
Â  Â  Â  Â  <p class="text-sm">â­ ${escapeHtml(item.rating)}</p>
Â  Â  Â  Â  <div class="mt-3 flex gap-2">
Â  Â  Â  Â  Â  <button class="btn btn-edit px-3 py-1 text-white" data-action="edit" data-row="${item.__row}">Edit</button>
Â  Â  Â  Â  Â  <button class="btn btn-delete px-3 py-1 text-white" data-action="delete" data-row="${item.__row}">Delete</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  `;
Â  Â  container.appendChild(card);
Â  });

Â  document.querySelectorAll('[data-action="edit"]').forEach(b=>b.addEventListener('click', onEditClick));
Â  document.querySelectorAll('[data-action="delete"]').forEach(b=>b.addEventListener('click', onDeleteClick));
}

// ---------------------- FILTERS ----------------------
function populateFilters(){
Â  const cats=[...new Set(productsData.map(p=>p.category))].sort();
Â  const subs=[...new Set(productsData.map(p=>p.subCategory))].sort();
Â  const comps=[...new Set(productsData.map(p=>p.company))].sort();
Â  const setOptions=(id,list)=>{
Â  Â  const el=document.getElementById(id);
Â  Â  el.innerHTML=`<option value="">All ${id.replace('Filter','')}</option>`+list.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
Â  };
Â  setOptions('categoryFilter',cats);
Â  setOptions('subCategoryFilter',subs);
Â  setOptions('companyFilter',comps);
}

document.getElementById('searchInput').addEventListener('input',applyFilters);
document.getElementById('categoryFilter').addEventListener('change',applyFilters);
document.getElementById('subCategoryFilter').addEventListener('change',applyFilters);
document.getElementById('companyFilter').addEventListener('change',applyFilters);
document.getElementById('rateSort').addEventListener('change',applyFilters);

function applyFilters(){
Â  const q=document.getElementById('searchInput').value.toLowerCase();
Â  const cat=document.getElementById('categoryFilter').value;
Â  const sub=document.getElementById('subCategoryFilter').value;
Â  const comp=document.getElementById('companyFilter').value;
Â  const sort=document.getElementById('rateSort').value;

Â  let filtered=productsData.filter(p=>{
Â  Â  const matchesSearch=q ? Object.values(p).some(v=>v && v.toString().toLowerCase().includes(q)) : true;
Â  Â  const matchesCat=cat ? p.category===cat : true;
Â  Â  const matchesSub=sub ? p.subCategory===sub : true;
Â  Â  const matchesComp=comp ? p.company===comp : true;
Â  Â  return matchesSearch && matchesCat && matchesSub && matchesComp;
Â  });

Â  if(sort==='low-high') filtered.sort((a,b)=>a.rate-b.rate);
Â  if(sort==='high-low') filtered.sort((a,b)=>b.rate-a.rate);

Â  renderProducts(filtered);
}

// ---------------------- EDIT/DELETE ----------------------
let pendingAction=null;
function onEditClick(ev){ pendingAction={type:'edit', row:+ev.currentTarget.dataset.row}; openModal('Enter security code to EDIT'); }
function onDeleteClick(ev){ pendingAction={type:'delete', row:+ev.currentTarget.dataset.row}; openModal('Enter security code to DELETE'); }
function openModal(title){
Â  document.getElementById('modalTitle').innerText=title;
Â  document.getElementById('modalCode').value='';
Â  document.getElementById('modalMsg').innerText='';
Â  document.getElementById('modal').style.display='flex';
}
document.getElementById('modalCancel').onclick=()=>document.getElementById('modal').style.display='none';
document.getElementById('modalConfirm').onclick=modalConfirm;

async function modalConfirm(){
Â  const code=document.getElementById('modalCode').value.trim();
Â  if(!code){ document.getElementById('modalMsg').innerText='Enter security code'; return; }
Â  document.getElementById('modalMsg').innerText='Verifying...';

Â  try{
Â  Â  const payload={action:pendingAction.type,row:pendingAction.row,code};
Â  Â  const res=await fetch(WEB_APP_URL,{
Â  Â  Â  method:'POST',
Â  Â  Â  headers:{'Content-Type':'application/json'},
Â  Â  Â  body:JSON.stringify(payload)
Â  Â  });
    if (!res.ok) throw new Error(`HTTP Error! Status: ${res.status}`); // Added status check
Â  Â  const result=await res.json();
Â  Â  if(result.success){
Â  Â  Â  document.getElementById('modalMsg').innerText=result.message;
Â  Â  Â  document.getElementById('modal').style.display='none';
Â  Â  Â  if(pendingAction.type==='edit'){
        // The Apps Script now returns all row data on successful verification, 
        // using the returned data is safer than relying on old sheet data.
Â  Â  Â  Â  const currentDescription = result.rowData && result.rowData.DESCRIPTION ? result.rowData.DESCRIPTION : '';
Â  Â  Â  Â  const newDesc=prompt('Enter new DESCRIPTION', currentDescription);
Â  Â  Â  Â  if(newDesc!==null){
Â  Â  Â  Â  Â  await fetch(WEB_APP_URL,{
Â  Â  Â  Â  Â  Â  method:'POST',
Â  Â  Â  Â  Â  Â  headers:{'Content-Type':'application/json'},
Â  Â  Â  Â  Â  Â  body:JSON.stringify({action:'applyEdit',row:pendingAction.row,code,updates:{DESCRIPTION:newDesc}})
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  alert('Update request sent. Reloading products...');
Â  Â  Â  Â  Â  loadProducts();
Â  Â  Â  Â  }
Â  Â  Â  }else if(pendingAction.type==='delete'){
Â  Â  Â  Â  alert('Product deleted (or marked deleted). Reloading products...');
Â  Â  Â  Â  loadProducts();
Â  Â  Â  }
Â  Â  }else{
Â  Â  Â  document.getElementById('modalMsg').innerText='Error: '+result.message;
Â  Â  }
Â  }catch(err){
Â  Â  console.error(err);
Â  Â  document.getElementById('modalMsg').innerText='Server error. Try again. Details: '+err.message;
Â  }
}

// ---------------------- INIT ----------------------
loadProducts();
</script>
</body>
</html>
