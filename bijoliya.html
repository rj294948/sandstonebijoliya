<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bijoliya Stone - Rajasthan SandStone Hub</title>
<link rel="icon" href="stone-icon.png" type="image/png">
<link rel="stylesheet" href="style.css">
<style>
/* ===== Modal ===== */
.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000;}
.modal-content {background:white; padding:25px; border-radius:12px; width:350px; position:relative;}
.modal-content h2 {text-align:center; color:#c7a97b; margin-bottom:15px;}
.modal-content input, .modal-content select {width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;}
.modal-content button {width:100%; padding:12px; border:none; background:#c7a97b; color:white; font-weight:600; border-radius:6px; cursor:pointer; margin-top:5px;}
.modal-content button:hover {background:#b38c5f;}
.modal-close {position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; color:#c7a97b;}
.modal a {text-decoration:none; color:#c7a97b; display:block; text-align:center; margin-top:10px;}
.feedback {text-align:center; margin-top:8px; font-weight:600; font-size:0.9rem;}

/* ===== Header ===== */
header {background:#c7a97b; color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;}
header h1 {font-size:1.5rem; cursor:pointer; margin:0;}
header div button {margin-left:5px;}

/* ===== Navigation ===== */
nav{display:flex;justify-content:center;gap:15px; background:#f3f3f3; padding:10px; flex-wrap:wrap;}
nav a{text-decoration:none;color:#333;font-weight:600;}

/* ===== Banner ===== */
.banner{background:#c7a97b;color:white;text-align:center;padding:30px;font-size:1.5rem;margin-bottom:10px;}

/* ===== Grid ===== */
.grid {display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:20px; margin:20px;}
.card {border:1px solid #ccc; border-radius:10px; padding:10px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.1); transition:transform 0.3s;}
.card:hover{transform:scale(1.02);}
.card img {width:100%; border-radius:8px; object-fit:cover; max-height:220px; cursor:pointer;}
.card .thumbnails {display:flex; gap:5px; justify-content:center; margin-top:5px;}
.card .thumbnails img {width:50px; height:50px; object-fit:cover; border-radius:5px; cursor:pointer; transition:0.2s;}
.card .thumbnails img:hover{border:2px solid #c7a97b;}

/* ===== Filter ===== */
.filter-container {display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:15px 0;}
.filter-container select, .filter-container button {padding:8px; border-radius:6px; border:1px solid #ccc; min-width:150px;}
.filter-container button {border:none; cursor:pointer;}
#filter-btn {background:#c7a97b; color:white;}
#clear-filter-btn {background:#b38c5f; color:white;}

/* ===== Footer ===== */
footer{background:#333;color:white;text-align:center;padding:15px;margin-top:20px;}
footer a{color:white;text-decoration:none;}

/* ===== UPDATED Image Modal Fullscreen ===== */
#image-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  z-index: 2000;
  overflow: hidden;
}

#image-modal .modal-container {
  display: flex;
  width: 100%;
  height: 100%;
  position: relative;
}

#image-modal .image-section {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
  position: relative;
}

#image-modal .image-wrapper {
  max-width: 100%;
  max-height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

#image-modal img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
}

#image-modal .details-section {
  width: 400px;
  background: white;
  padding: 25px;
  overflow-y: auto;
  border-left: 1px solid #eee;
}

#image-modal .close-btn,
#image-modal .prev-btn,
#image-modal .next-btn {
  position: absolute;
  background: rgba(0, 0, 0, 0.7);
  border: none;
  color: white;
  cursor: pointer;
  border-radius: 50%;
  transition: all 0.3s;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2001;
}

#image-modal .close-btn {
  top: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  font-size: 24px;
}

#image-modal .prev-btn,
#image-modal .next-btn {
  top: 50%;
  transform: translateY(-50%);
  width: 60px;
  height: 60px;
  font-size: 28px;
}

#image-modal .prev-btn {
  left: 20px;
}

#image-modal .next-btn {
  right: 420px; /* Adjust based on details section width */
}

#image-modal .close-btn:hover,
#image-modal .prev-btn:hover,
#image-modal .next-btn:hover {
  background: rgba(0, 0, 0, 0.9);
  transform: scale(1.1);
}

#image-modal .image-counter {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  z-index: 2001;
}

.modal-details h3 {
  margin-top: 0;
  color: #c7a97b;
  font-size: 1.5rem;
  border-bottom: 2px solid #c7a97b;
  padding-bottom: 10px;
}

.modal-details p {
  margin: 12px 0;
  line-height: 1.5;
}

.modal-details strong {
  color: #333;
  min-width: 120px;
  display: inline-block;
}

.modal-details a {
  color: #c7a97b;
  text-decoration: none;
  font-weight: 600;
}

.modal-details a:hover {
  text-decoration: underline;
}

.contact-buttons {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.contact-buttons button {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
}

.whatsapp-btn {
  background: #25D366;
  color: white;
}

.email-btn {
  background: #D44638;
  color: white;
}

.contact-buttons button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* Responsive Design */
@media (max-width: 1024px) {
  #image-modal .modal-container {
    flex-direction: column;
  }
  
  #image-modal .details-section {
    width: 100%;
    max-height: 40%;
    border-left: none;
    border-top: 1px solid #eee;
  }
  
  #image-modal .next-btn {
    right: 20px;
  }
  
  #image-modal .image-section {
    height: 60%;
  }
}

@media (max-width: 768px) {
  #image-modal .prev-btn,
  #image-modal .next-btn {
    width: 50px;
    height: 50px;
    font-size: 20px;
  }
  
  #image-modal .close-btn {
    width: 40px;
    height: 40px;
    font-size: 18px;
  }
  
  .modal-details {
    padding: 15px;
  }
  
  .contact-buttons {
    flex-direction: column;
  }
}

/* Loading animation for images */
.image-loading {
  background: #f0f0f0;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 300px;
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #c7a97b;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>
<body>

<header>
  <h1 onclick="window.location='index.html'">ü™® Bijoliya Stone</h1>
  <div>
    <button id="home-btn" onclick="window.location='index.html'">Home</button>
    <button id="history-btn" style="display:none;" onclick="window.location='history.html'">My History</button>
    <button id="btn-open-signin">Sign In</button>
    <button id="btn-open-signup">Sign Up</button>
    <button id="btn-google-signin">Sign In with Gmail</button>
    <button id="btn-signout" style="display:none;">Sign Out</button>
    <button id="btn-post" style="display:none;"><a href="admin.html">Post Product</a></button>
  </div>
</header>

<nav>
  <a href="sandstone.html">Sand Stone</a>
  <a href="kota.html">Kota Stone</a>
  <a href="granite.html">Granite</a>
  <a href="marble.html">Marble</a>
  <a href="bijoliya.html">Bijoliya</a>
  <a href="dholpur.html">Dholpur</a>
  <a href="tiles.html">Tiles</a>
  <a href="mandana.html">Mandana</a>
  <a href="other-stones.html">Other Stones</a>
  <a href="factories.html">Factories</a>
  <a href="about.html">About Us</a>
  <a href="contact.html">Contact</a>
  <a href="privacy.html">Privacy Policy</a>
  <a href="terms.html">Terms & Conditions</a>
</nav>

<div class="banner">Discover Natural Stones of Bijoliya</div>

<div class="filter-container">
  <select id="filter-factory"><option value="">All Factories</option></select>
  <select id="filter-subcat"><option value="">All Sub-categories</option></select>
  <select id="filter-type"><option value="">All Types</option></select>
  <select id="filter-color"><option value="">All Colors</option></select>
  <select id="filter-price"><option value="">Max Price</option></select>
  <button id="filter-btn">Apply</button>
  <button id="clear-filter-btn">Clear</button>
</div>

<section>
  <h2>Available Products</h2>
  <div class="grid" id="product-grid"></div>
</section>

<footer>
  &copy; 2025 Rajasthan SandStone Hub | Designed by RJ Services | 
  <a href="about.html">About Us</a> | <a href="contact.html">Contact</a>
</footer>

<!-- ===== Sign In Modal ===== -->
<div class="modal" id="signin-modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h2>Sign In</h2>
    <input type="email" id="signin-email" placeholder="Email">
    <input type="password" id="signin-password" placeholder="Password">
    <button id="signin-btn">Sign In</button>
    <div style="text-align:center;margin:10px 0;">OR</div>
    <button id="modal-google-signin" style="background:#4285F4;color:white; display:flex; align-items:center; justify-content:center; gap:8px;">
      <img src="download.png" alt="Google" style="width:20px; height:20px;"> Sign In with Google
    </button>
    <div class="feedback" id="signin-feedback"></div>
    <a href="#" onclick="openModal('signup-modal'); closeModal('signin-modal')">Don't have an account? Sign Up</a>
  </div>
</div>

<!-- ===== Sign Up Modal ===== -->
<div class="modal" id="signup-modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h2>Create Account</h2>
    <input type="text" id="signup-name" placeholder="Full Name">
    <input type="email" id="signup-email" placeholder="Email">
    <input type="password" id="signup-password" placeholder="Password">
    <input type="text" id="signup-phone" placeholder="Phone Number">
    <button id="signup-btn">Sign Up</button>
    <div class="feedback" id="signup-feedback"></div>
    <a href="#" onclick="openModal('signin-modal'); closeModal('signup-modal')">Already have an account? Sign In</a>
  </div>
</div>

<!-- ===== UPDATED Image Modal with Details ===== -->
<div id="image-modal">
  <div class="modal-container">
    <div class="image-section">
      <div class="image-wrapper">
        <img id="modal-img" src="" alt="Stone Image" onload="hideLoading()">
        <div id="image-loading" class="image-loading" style="display:none;">
          <div class="spinner"></div>
        </div>
      </div>
      <button class="prev-btn">&#10094;</button>
      <button class="next-btn">&#10095;</button>
      <button class="close-btn">&times;</button>
      <div class="image-counter" id="image-counter">1 / 1</div>
    </div>
    
    <div class="details-section">
      <div class="modal-details">
        <h3 id="modal-stone-name">Stone Name</h3>
        <p><strong>Company:</strong> <span id="modal-company">-</span></p>
        <p><strong>Sub-category:</strong> <span id="modal-subcat">-</span></p>
        <p><strong>Type:</strong> <span id="modal-type">-</span></p>
        <p><strong>Color:</strong> <span id="modal-color">-</span></p>
        <p><strong>Price:</strong> ‚Çπ<span id="modal-price">-</span> per <span id="modal-unit">-</span></p>
        <p><strong>Address:</strong> <span id="modal-address">-</span></p>
        <p><strong>Contact:</strong> <span id="modal-contact">-</span></p>
        <p><strong>Email:</strong> <span id="modal-email-text">-</span></p>
        <p id="modal-description"><strong>Description:</strong> <span id="modal-desc-text">No description available</span></p>
        
        <div class="contact-buttons">
          <button class="whatsapp-btn" id="modal-whatsapp-btn">
            üì± WhatsApp
          </button>
          <button class="email-btn" id="modal-email-btn">
            ‚úâÔ∏è Email
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
// ===== Firebase Imports =====
import { db, auth } from './firebase-config.js';
import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

/* ===== Modal Functions ===== */
function openModal(id){ document.getElementById(id).style.display='flex'; }
function closeModal(id){ document.getElementById(id).style.display='none'; }
document.querySelectorAll('.modal-close').forEach(btn=>{ btn.addEventListener('click', ()=>{ btn.closest('.modal').style.display='none'; }); });
document.addEventListener('keydown', (e)=>{ if(e.key === "Escape"){ document.querySelectorAll('.modal').forEach(modal=> modal.style.display='none'); } });

/* ===== Header Buttons & Auth ===== */
const btnOpenSignin = document.getElementById('btn-open-signin');
const btnOpenSignup = document.getElementById('btn-open-signup');
const btnGoogleSignin = document.getElementById('btn-google-signin');
const btnSignOut = document.getElementById('btn-signout');
const btnPost = document.getElementById('btn-post');
const historyBtn = document.getElementById('history-btn');
btnOpenSignin.addEventListener('click', ()=>openModal('signin-modal'));
btnOpenSignup.addEventListener('click', ()=>openModal('signup-modal'));

const provider = new GoogleAuthProvider();
document.getElementById('modal-google-signin').addEventListener('click', async ()=>{
  try{ const result = await signInWithPopup(auth, provider); alert(`Signed in as ${result.user.displayName}`); closeModal('signin-modal'); }
  catch(err){ alert(err.message); }
});
btnGoogleSignin.addEventListener('click', async ()=>{ try{ const result = await signInWithPopup(auth, provider); alert(`Signed in as ${result.user.displayName}`); } catch(err){ alert(err.message); } });
btnSignOut.addEventListener('click', async ()=>{ await signOut(auth); alert('Signed out successfully'); });

const signinBtn = document.getElementById('signin-btn');
const signinFeedback = document.getElementById('signin-feedback');
signinBtn.addEventListener('click', async ()=>{
  const email = document.getElementById('signin-email').value.trim();
  const password = document.getElementById('signin-password').value.trim();
  signinFeedback.textContent='';
  try{ await signInWithEmailAndPassword(auth,email,password);
       signinFeedback.style.color='green'; signinFeedback.textContent='‚úÖ Signed in successfully!';
       closeModal('signin-modal');
  }catch(err){ signinFeedback.style.color='red'; signinFeedback.textContent='‚ùå '+err.message; }
});

const signupBtn = document.getElementById('signup-btn');
const signupFeedback = document.getElementById('signup-feedback');
signupBtn.addEventListener('click', async ()=>{
  const name = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const password = document.getElementById('signup-password').value.trim();
  const phone = document.getElementById('signup-phone').value.trim();
  signupFeedback.textContent='';
  try{
    const userCredential = await createUserWithEmailAndPassword(auth,email,password);
    await updateProfile(userCredential.user,{displayName:name,phoneNumber:phone});
    signupFeedback.style.color='green'; signupFeedback.textContent='‚úÖ Account created successfully!';
    closeModal('signup-modal');
  }catch(err){ signupFeedback.style.color='red'; signupFeedback.textContent='‚ùå '+err.message; }
});

onAuthStateChanged(auth,user=>{
  if(user){
    btnOpenSignin.style.display='none'; btnOpenSignup.style.display='none'; btnGoogleSignin.style.display='none';
    btnSignOut.style.display='inline-block'; btnPost.style.display='inline-block'; historyBtn.style.display='inline-block';
  }else{
    btnOpenSignin.style.display='inline-block'; btnOpenSignup.style.display='inline-block'; btnGoogleSignin.style.display='inline-block';
    btnSignOut.style.display='none'; btnPost.style.display='none'; historyBtn.style.display='none';
  }
});

/* ===== Firestore Products ===== */
const productGrid = document.getElementById('product-grid');
let products = [];

const filterFactory = document.getElementById('filter-factory');
const filterSubcat = document.getElementById('filter-subcat');
const filterType = document.getElementById('filter-type');
const filterColor = document.getElementById('filter-color');
const filterPrice = document.getElementById('filter-price');
const filterBtn = document.getElementById('filter-btn');
const clearBtn = document.getElementById('clear-filter-btn');

async function loadProducts(){
 try {
   const q = query(collection(db, "products"), where("category", "==", "Bijoliya"));
   const snapshot = await getDocs(q);
   products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
   console.log('Loaded products:', products.length);
   populateFilterOptions();
   renderProducts(products);
 } catch (error) {
   console.error('Error loading products:', error);
   productGrid.innerHTML = '<p>Error loading products. Please try again later.</p>';
 }
}

function populateFilterOptions(){
  const factories = new Set(), subcats = new Set(), types = new Set(), colors = new Set(), prices = [];
  products.forEach(p=>{
    if(p.factory_name) factories.add(p.factory_name);
    if(p.sub_category) subcats.add(p.sub_category);
    if(p.type) types.add(p.type);
    if(p.color) colors.add(p.color);
    if(p.price) prices.push(p.price);
  });
  addOptions(filterFactory, Array.from(factories));
  addOptions(filterSubcat, Array.from(subcats));
  addOptions(filterType, Array.from(types));
  addOptions(filterColor, Array.from(colors));
  
  // Price filter with ranges
  filterPrice.innerHTML = '<option value="">All Prices</option>';
  if(prices.length > 0) {
    const maxPrice = Math.max(...prices);
    const priceRanges = [
      {max: 1000, label: "Up to ‚Çπ1000"},
      {max: 5000, label: "Up to ‚Çπ5000"},
      {max: 10000, label: "Up to ‚Çπ10000"},
      {max: 20000, label: "Up to ‚Çπ20000"},
      {max: 50000, label: "Up to ‚Çπ50000"},
      {max: maxPrice, label: `Up to ‚Çπ${maxPrice}`}
    ];
    priceRanges.forEach(range => {
      if(range.max <= maxPrice) {
        filterPrice.innerHTML += `<option value="${range.max}">${range.label}</option>`;
      }
    });
  }
}

function addOptions(select, arr){
  select.innerHTML = `<option value="">All</option>`;
  arr.forEach(val=>{ 
    if(val && val.trim() !== '') {
      select.innerHTML += `<option value="${val}">${val}</option>`;
    }
  });
}

/* ===== Render Products ===== */
function renderProducts(list){
  productGrid.innerHTML = '';
  
  if(list.length === 0) {
    productGrid.innerHTML = '<p style="grid-column:1/-1; text-align:center; padding:40px; color:#666;">No products found matching your criteria.</p>';
    return;
  }
  
  list.forEach((p, index)=>{
    const card = document.createElement('div'); 
    card.className='card';
    
    let imagesHtml='';
    if(p.images && p.images.length>0){
      // Preload first image for better performance
      const img = new Image();
      img.src = p.images[0];
      
      imagesHtml += `<img src="${p.images[0]}" alt="${p.stone_name}" loading="lazy" onclick="openImageModal(${index},0)">`;
      
      if(p.images.length>1){
        imagesHtml += `<div class="thumbnails">`;
        p.images.forEach((img,idx)=>{ 
          imagesHtml += `<img src="${img}" alt="${p.stone_name}" loading="lazy" onclick="openImageModal(${index},${idx})">`; 
        });
        imagesHtml += `</div>`;
      }
    } else { 
      imagesHtml = `<img src="stone-placeholder.png" alt="${p.stone_name}" style="background:#f0f0f0; padding:20px;">`;
    }

    const whatsappNumber = p.contact_number || '';
    const whatsappMessage = encodeURIComponent(`Hello, I am interested in your product: ${p.stone_name}.\nCompany: ${p.factory_name || '-'}\nPrice: ‚Çπ${p.price || '-'} per ${p.price_unit || '-'}`);
    const whatsappLink = `https://wa.me/${whatsappNumber}?text=${whatsappMessage}`;
    
    const emailAddress = p.email || 'info@example.com';
    const emailSubject = encodeURIComponent(`Inquiry about ${p.stone_name}`);
    const emailBody = encodeURIComponent(`Hello,\n\nI am interested in your product:\n\nStone Name: ${p.stone_name}\nCompany: ${p.factory_name || '-'}\nType: ${p.type || '-'}\nColor: ${p.color || '-'}\nPrice: ‚Çπ${p.price || '-'} per ${p.price_unit || '-'}\nAddress: ${p.address || '-'}\n\nPlease provide more details.\n\nThanks.`);
    const gmailLink = `mailto:${emailAddress}?subject=${emailSubject}&body=${emailBody}`;

    card.innerHTML = `${imagesHtml}
      <h3>${p.stone_name || 'Stone Name'}</h3>
      <p><strong>Company:</strong> ${p.factory_name || '-'}</p>
      <p><strong>Type:</strong> ${p.type || '-'}</p>
      <p><strong>Color:</strong> ${p.color || '-'}</p>
      <p><strong>Price:</strong> ‚Çπ${p.price || '-'} per ${p.price_unit || '-'}</p>
      <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
        <a href="${whatsappLink}" target="_blank"><button style="background:#25D366;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:0.9rem;">WhatsApp</button></a>
        <a href="${gmailLink}" target="_blank"><button style="background:#D44638;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:0.9rem;">Email</button></a>
      </div>`;
    productGrid.appendChild(card);
  });
}

/* ===== Filter Logic ===== */
filterBtn.addEventListener('click', ()=>{
  const filtered = products.filter(p=>{
    return (!filterFactory.value || (p.factory_name && p.factory_name === filterFactory.value)) &&
           (!filterSubcat.value || (p.sub_category && p.sub_category === filterSubcat.value)) &&
           (!filterType.value || (p.type && p.type === filterType.value)) &&
           (!filterColor.value || (p.color && p.color === filterColor.value)) &&
           (!filterPrice.value || (p.price && p.price <= parseFloat(filterPrice.value)));
  });
  renderProducts(filtered);
});

clearBtn.addEventListener('click', ()=>{
  filterFactory.value=''; filterSubcat.value=''; filterType.value=''; filterColor.value=''; filterPrice.value='';
  renderProducts(products);
});

/* ===== UPDATED Image Modal with Full Image Display ===== */
const imageModal = document.getElementById('image-modal');
const modalImg = document.getElementById('modal-img');
const closeBtn = document.querySelector('#image-modal .close-btn');
const prevBtn = document.querySelector('#image-modal .prev-btn');
const nextBtn = document.querySelector('#image-modal .next-btn');
const imageCounter = document.getElementById('image-counter');
const imageLoading = document.getElementById('image-loading');

// Detail elements
const modalStoneName = document.getElementById('modal-stone-name');
const modalCompany = document.getElementById('modal-company');
const modalSubcat = document.getElementById('modal-subcat');
const modalType = document.getElementById('modal-type');
const modalColor = document.getElementById('modal-color');
const modalPrice = document.getElementById('modal-price');
const modalUnit = document.getElementById('modal-unit');
const modalAddress = document.getElementById('modal-address');
const modalContact = document.getElementById('modal-contact');
const modalEmailText = document.getElementById('modal-email-text');
const modalDescText = document.getElementById('modal-desc-text');
const modalWhatsappBtn = document.getElementById('modal-whatsapp-btn');
const modalEmailBtn = document.getElementById('modal-email-btn');

let currentProductIndex = 0;
let currentImageIndex = 0;

// Show loading when image is loading
function showLoading() {
  imageLoading.style.display = 'flex';
  modalImg.style.display = 'none';
}

function hideLoading() {
  imageLoading.style.display = 'none';
  modalImg.style.display = 'block';
}

window.openImageModal = (prodIdx, imgIdx) => {
  currentProductIndex = prodIdx;
  currentImageIndex = imgIdx;
  const p = products[currentProductIndex];
  
  showLoading();
  
  // Preload image for better user experience
  const img = new Image();
  img.onload = () => {
    modalImg.src = p.images[currentImageIndex];
    hideLoading();
  };
  img.onerror = () => {
    modalImg.src = 'stone-placeholder.png';
    hideLoading();
  };
  img.src = p.images[currentImageIndex];
  
  // Update details
  modalStoneName.textContent = p.stone_name || 'Stone Name';
  modalCompany.textContent = p.factory_name || 'Not specified';
  modalSubcat.textContent = p.sub_category || 'Not specified';
  modalType.textContent = p.type || 'Not specified';
  modalColor.textContent = p.color || 'Not specified';
  modalPrice.textContent = p.price || 'Not specified';
  modalUnit.textContent = p.price_unit || 'unit';
  modalAddress.textContent = p.address || 'Not specified';
  modalContact.textContent = p.contact_number || 'Not specified';
  modalEmailText.textContent = p.email || 'Not specified';
  modalDescText.textContent = p.description || 'No description available';
  
  // Update contact links
  const whatsappMessage = encodeURIComponent(`Hello, I am interested in your product: ${p.stone_name}`);
  const whatsappLink = `https://wa.me/${p.contact_number || ''}?text=${whatsappMessage}`;
  const emailLink = `mailto:${p.email || 'info@example.com'}?subject=${encodeURIComponent(`Inquiry about ${p.stone_name}`)}`;
  
  modalWhatsappBtn.onclick = () => window.open(whatsappLink, '_blank');
  modalEmailBtn.onclick = () => window.open(emailLink, '_blank');
  
  // Update image counter
  updateImageCounter();
  
  // Show modal
  imageModal.style.display = 'block';
  document.body.style.overflow = 'hidden';
};

function updateImageCounter() {
  const totalImages = products[currentProductIndex].images.length;
  imageCounter.textContent = `${currentImageIndex + 1} / ${totalImages}`;
}

// Event listeners for modal navigation
closeBtn.addEventListener('click', () => {
  imageModal.style.display = 'none';
  document.body.style.overflow = 'auto';
});

prevBtn.addEventListener('click', () => {
  const imgs = products[currentProductIndex].images;
  currentImageIndex = (currentImageIndex - 1 + imgs.length) % imgs.length;
  showLoading();
  modalImg.src = imgs[currentImageIndex];
  updateImageCounter();
});

nextBtn.addEventListener('click', () => {
  const imgs = products[currentProductIndex].images;
  currentImageIndex = (currentImageIndex + 1) % imgs.length;
  showLoading();
  modalImg.src = imgs[currentImageIndex];
  updateImageCounter();
});

// Close modal when clicking on background
imageModal.addEventListener('click', (e) => {
  if (e.target === imageModal) {
    imageModal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
  if (imageModal.style.display === 'block') {
    if (e.key === 'ArrowLeft') prevBtn.click();
    if (e.key === 'ArrowRight') nextBtn.click();
    if (e.key === 'Escape') closeBtn.click();
  }
});

// Handle image load errors
modalImg.addEventListener('error', () => {
  modalImg.src = 'stone-placeholder.png';
  hideLoading();
});

window.onload = loadProducts;
</script>
</body>
</html>
