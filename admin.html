<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Rajasthan SandStone Hub</title>
<link rel="icon" href="stone-icon.png">
<link rel="stylesheet" href="style.css">
<style>
body {font-family:"Poppins",sans-serif;background:#f5f5f5;margin:0;padding:0;}
header {background:#c7a97b;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;color:white;}
header h1 {font-size:1.5rem;cursor:pointer;}
header button {padding:8px 15px;border:none;background:#fff;color:#c7a97b;border-radius:6px;cursor:pointer;font-weight:600;}
header button:hover {background:#b38c5f;color:white;}
.container {padding:20px;max-width:1200px;margin:auto;}
h2 {color:#c7a97b;margin-bottom:15px;text-align:center;}
form {background:white;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-bottom:30px;}
form input,form select,form textarea {width:100%;padding:10px;margin-bottom:15px;border-radius:6px;border:1px solid #ccc;}
form button {background:#c7a97b;color:white;font-weight:600;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;transition:0.3s;}
form button:hover {background:#b38c5f;}
#product-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;}
.card {background:white;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:10px;position:relative;}
.card img {width:100%;height:160px;object-fit:cover;border-radius:6px;}
.card h3 {margin:10px 0 5px 0;color:#333;}
.card p {margin:2px 0;font-size:0.9rem;color:#555;}
.card .actions {margin-top:10px;}
.card .actions a {text-decoration:none;margin-right:8px;color:#c7a97b;font-weight:600;}
.card .actions a:hover {text-decoration:underline;}
.card button {position:absolute;top:10px;right:10px;background:red;color:white;border:none;padding:5px 8px;border-radius:4px;cursor:pointer;}
</style>
</head>
<body>

<header>
  <h1 onclick="window.location='index.html'">ðŸª¨ Rajasthan SandStone Hub</h1>
  <button id="logout-btn">Logout</button>
</header>

<div class="container">
  <h2>Add New Stone Product</h2>
  <form id="product-form">
    <input type="text" id="stone_name" placeholder="Stone Name" required>
    <input type="text" id="category" placeholder="Category (Bijoliya, Dholpur, etc.)" required>
    <input type="text" id="sub_category" placeholder="Sub-category (optional)">
    <input type="text" id="type" placeholder="Type (Farsi, Gitti, Poll...)" required>
    <input type="text" id="color" placeholder="Color" required>
    <textarea id="description" placeholder="Description" rows="3"></textarea>
    <input type="number" id="price" placeholder="Price" required>
    <input type="text" id="price_unit" placeholder="Unit (sqft, piece...)" required>
    <input type="text" id="contact_number" placeholder="Contact Number" required>
    <input type="email" id="email_id" placeholder="Email (optional)">
    <input type="text" id="factory_name" placeholder="Factory Name" required>
    <input type="text" id="image_url" placeholder="Image URL" required>
    <button type="submit">Add Product</button>
  </form>

  <h2>My Products</h2>
  <div id="product-grid"></div>
</div>

<script type="module">
import { auth, db, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, signOut } from './firebase-config.js';

const form = document.getElementById('product-form');
const productGrid = document.getElementById('product-grid');
const logoutBtn = document.getElementById('logout-btn');
let products = [];

// Logout
logoutBtn.addEventListener('click', async () => {
  await signOut(auth);
  window.location = 'signin.html';
});

// Auth check
auth.onAuthStateChanged(user => {
  if (!user) window.location = 'signin.html';
  else loadMyProducts(user.uid);
});

// Load only userâ€™s own products
async function loadMyProducts(uid) {
  const q = query(collection(db, "products"), orderBy("created_at", "desc"));
  const snapshot = await getDocs(q);
  products = snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
    .filter(p => p.userId === uid);
  renderProducts(products);
}

// Render products
function renderProducts(list) {
  productGrid.innerHTML = '';
  if (!list.length) {
    productGrid.innerHTML = '<p>No products posted yet.</p>';
    return;
  }
  list.forEach(p => {
    const waLink = `https://wa.me/${p.contact_number}?text=Hi, I'm interested in your product: ${p.stone_name}`;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <img src="${p.image}" alt="${p.stone_name}">
      <h3>${p.stone_name}</h3>
      <p><strong>Category:</strong> ${p.category}</p>
      ${p.sub_category ? `<p><strong>Sub-category:</strong> ${p.sub_category}</p>` : ''}
      <p><strong>Type:</strong> ${p.type}</p>
      <p><strong>Color:</strong> ${p.color}</p>
      <p><strong>Price:</strong> â‚¹${p.price} / ${p.price_unit}</p>
      <p><strong>Factory:</strong> ${p.factory_name}</p>
      <div class="actions">
        <a href="${waLink}" target="_blank">ðŸ’¬ WhatsApp</a>
        <a href="tel:${p.contact_number}">ðŸ“ž Call</a>
        ${p.email_id ? `<a href="mailto:${p.email_id}">ðŸ“§ Email</a>` : ''}
      </div>
      <button onclick="deleteProduct('${p.id}')">ðŸ—‘ Delete</button>
    `;
    productGrid.appendChild(card);
  });
}

// Add product
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const user = auth.currentUser;
  const data = {
    stone_name: form.stone_name.value.trim(),
    category: form.category.value.trim() || "Other",
    sub_category: form.sub_category.value.trim() || "",
    type: form.type.value.trim(),
    color: form.color.value.trim(),
    description: form.description.value.trim(),
    price: parseFloat(form.price.value),
    price_unit: form.price_unit.value.trim(),
    contact_number: form.contact_number.value.trim(),
    email_id: form.email_id.value.trim(),
    factory_name: form.factory_name.value.trim(),
    image: form.image_url.value.trim(),
    created_at: new Date(),
    userId: user.uid,
    userEmail: user.email
  };
  await addDoc(collection(db, "products"), data);
  form.reset();
  loadMyProducts(user.uid);
});

// Delete product
window.deleteProduct = async (id) => {
  if (confirm("Are you sure you want to delete this product?")) {
    await deleteDoc(doc(db, "products", id));
    loadMyProducts(auth.currentUser.uid);
  }
};
</script>

</body>
</html>
