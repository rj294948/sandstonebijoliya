<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Rajasthan SandStone Hub</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- âœ… Common Navbar -->
<header class="main-header">
  <div class="logo" onclick="window.location='index.html'">ðŸª¨ Rajasthan SandStone Hub</div>
  <nav>
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="products.html">Products</a>
    <a href="factories.html">Factories</a>
    <a href="contact.html">Contact</a>
    <a href="privacy.html">Privacy</a>
    <a href="terms.html">Terms</a>
    <a href="admin.html">Admin</a>
    <a href="history.html">History</a>
  </nav>
</header>

<div class="container">
  <h2>Add New Stone Product</h2>
  <form id="product-form">
    <input type="text" id="stone_name" placeholder="Stone Name" required>
    <input type="text" id="category" placeholder="Category (Bijoliya, Dholpur...)" required>
    <input type="text" id="sub_category" placeholder="Sub-category (Tile, Slab...)" >
    <input type="text" id="type" placeholder="Type (Farsi, Gitti, Poll...)" required>
    <input type="text" id="color" placeholder="Color" required>
    <textarea id="description" placeholder="Description" rows="3"></textarea>
    <input type="number" id="price" placeholder="Price" required>
    <input type="text" id="price_unit" placeholder="Unit (sqf, piece...)" required>
    <input type="text" id="contact_number" placeholder="Contact Number" required>
    <input type="text" id="factory_name" placeholder="Factory Name" required>
    <input type="email" id="email" placeholder="Email (optional)">
    
    <!-- âœ… Image Upload -->
    <label>Upload Image:</label>
    <input type="file" id="image_file" accept="image/*" required>
    
    <button type="submit">Add Product</button>
  </form>

  <h2>My Products</h2>
  <div id="product-grid"></div>
</div>

<script type="module">
import { auth, db, storage } from './firebase-config.js';
import { collection, addDoc, getDocs, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

const productForm=document.getElementById("product-form");
const grid=document.getElementById("product-grid");

onAuthStateChanged(auth,user=>{
  if(!user)window.location='signin.html';
});

async function loadProducts(){
  const q=query(collection(db,"products"),orderBy("created_at","desc"));
  const snap=await getDocs(q);
  grid.innerHTML="";
  snap.forEach(d=>{
    const p=d.data();
    grid.innerHTML+=`
      <div class="card">
        <img src="${p.image}" style="width:100%;height:150px;object-fit:cover;border-radius:8px;">
        <h3>${p.stone_name}</h3>
        <p>${p.category} | â‚¹${p.price}/${p.price_unit}</p>
        <p><a href="https://wa.me/${p.contact_number}" target="_blank">WhatsApp</a> | 
        <a href="tel:${p.contact_number}">Call</a></p>
        <button onclick="deleteProduct('${d.id}')">ðŸ—‘ Delete</button>
      </div>`;
  });
}

window.deleteProduct=async(id)=>{
  if(confirm("Delete this product?")){
    await deleteDoc(doc(db,"products",id));
    loadProducts();
  }
};

productForm.addEventListener("submit",async e=>{
  e.preventDefault();
  const user=auth.currentUser;
  if(!user)return alert("Please sign in first!");

  const file=document.getElementById("image_file").files[0];
  const storageRef=ref(storage,`products/${Date.now()}_${file.name}`);
  await uploadBytes(storageRef,file);
  const imageUrl=await getDownloadURL(storageRef);

  await addDoc(collection(db,"products"),{
    stone_name:productForm.stone_name.value,
    category:productForm.category.value,
    sub_category:productForm.sub_category.value||"",
    type:productForm.type.value,
    color:productForm.color.value,
    description:productForm.description.value,
    price:parseFloat(productForm.price.value),
    price_unit:productForm.price_unit.value,
    contact_number:productForm.contact_number.value,
    factory_name:productForm.factory_name.value,
    email:productForm.email.value||"",
    image:imageUrl,
    created_at:new Date(),
    userId:user.uid
  });

  alert("âœ… Product added successfully!");
  productForm.reset();
  loadProducts();
});

loadProducts();
</script>

</body>
</html>
