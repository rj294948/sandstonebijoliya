<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Rajasthan SandStone Hub</title>
<link rel="icon" href="stone.png" type="image/png">
<style>
/* ===== Modal ===== */
.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000;}
.modal-content {background:white; padding:25px; border-radius:12px; width:350px; position:relative;}
.modal-content h2 {text-align:center; color:#c7a97b; margin-bottom:15px;}
.modal-content input, .modal-content select {width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;}
.modal-content button {width:100%; padding:12px; border:none; background:#c7a97b; color:white; font-weight:600; border-radius:6px; cursor:pointer; margin-top:5px;}
.modal-content button:hover {background:#b38c5f;}
.modal-close {position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; color:#c7a97b;}
.modal a {text-decoration:none; color:#c7a97b; display:block; text-align:center; margin-top:10px;}
.feedback {text-align:center; margin-top:8px; font-weight:600; font-size:0.9rem;}

/* ===== Header ===== */
body {font-family:Arial, sans-serif; background:#f5f5f5; margin:0;}
header {background:#c7a97b; color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;}
header h1 {font-size:1.5rem; cursor:pointer; display:flex; align-items:center; gap:10px; margin:0;}
header h1 img {height:40px; border-radius:5px;}
header div button {margin-left:5px; padding:8px 15px; border:none; background:white; color:#c7a97b; border-radius:6px; cursor:pointer; font-weight:600;}

/* ===== Navigation ===== */
nav {display:flex; justify-content:center; gap:15px; background:#f3f3f3; padding:10px; flex-wrap:wrap;}
nav a {text-decoration:none; color:#333; font-weight:600;}

/* ===== Container ===== */
.container {padding:20px; max-width:1200px; margin:auto;}
h2 {color:#444; text-align:center; margin-bottom:20px;}
form {background:white; padding:30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
.form-group {margin-bottom:20px;}
.form-group label {display:block; margin-bottom:8px; color:#555; font-weight:600;}
select, input, textarea {width:100%; padding:12px; border-radius:6px; border:1px solid #ccc; font-size:1rem; box-sizing:border-box;}
button {background:#c7a97b; color:white; font-weight:600; border:none; padding:12px 25px; border-radius:6px; cursor:pointer; font-size:1rem;}
button:hover {background:#b38c5f;}
.preview {display:flex; flex-wrap:wrap; gap:10px; margin:15px 0;}
.preview img {width:140px; height:140px; object-fit:cover; border-radius:8px; border:2px solid #ddd;}
footer {background:#333; color:white; text-align:center; padding:15px; margin-top:40px;}
footer a {color:white; text-decoration:none;}
</style>
</head>
<body>

<header>
  <h1><img src="stone.png" alt="Logo">Rajasthan Stones</h1>
  <div>
    <button id="home-btn" onclick="window.location='index.html'">Home</button>
    <button id="history-btn" style="display:none;" onclick="window.location='history.html'">My History</button>
    <button id="btn-open-signin">Sign In</button>
    <button id="btn-open-signup">Sign Up</button>
    <button id="btn-google-signin">Sign In with Gmail</button>
    <button id="btn-signout" style="display:none;">Sign Out</button>
  </div>
</header>

<nav>
  <a href="sandstone.html">Sand Stone</a>
  <a href="kota.html">Kota Stone</a>
  <a href="granite.html">Granite</a>
  <a href="marble.html">Marble</a>
  <a href="bijoliya.html">Bijoliya</a>
  <a href="dholpur.html">Dholpur</a>
  <a href="tiles.html">Tiles</a>
  <a href="mandana.html">Mandana</a>
  <a href="other-stones.html">Other Stones</a>
  <a href="factories.html">Factories</a>
  <a href="about.html">About Us</a>
  <a href="contact.html">Contact</a>
  <a href="privacy.html">Privacy Policy</a>
  <a href="terms.html">Terms & Conditions</a>
</nav>

<div class="container">
  <h2>Add / Edit Stone Product</h2>

  <form id="product-form">
    <input type="hidden" id="product-id">

    <div class="form-group">
      <label for="category">Category *</label>
      <select id="category" required>
        <option value="">Select Category</option>
        <option>Sand Stone</option>
        <option>Kota Stone</option>
        <option>Granite</option>
        <option>Marble</option>
        <option>Bijoliya</option>
        <option>Dholpur</option>
        <option>Tiles</option>
        <option>Mandana</option>
        <option>Other Stones</option>
      </select>
    </div>

    <div class="form-group">
      <label for="stone_name">Stone Name *</label>
      <input type="text" id="stone_name" placeholder="Stone Name" required readonly>
    </div>

    <div class="form-group">
      <label for="sub_category">Sub-category</label>
      <input type="text" id="sub_category" placeholder="Sub-category (Optional)">
    </div>

    <div class="form-group">
      <label for="type">Type</label>
      <input type="text" id="type" placeholder="Type (Optional)">
    </div>

    <div class="form-group">
      <label for="color">Color</label>
      <input type="text" id="color" placeholder="Color (Optional)">
    </div>

    <div class="form-group">
      <label for="description">Description</label>
      <textarea id="description" placeholder="Description (Optional)" rows="3"></textarea>
    </div>

    <div class="form-group">
      <label for="price">Price</label>
      <input type="number" id="price" placeholder="Price (Optional)">
    </div>

    <div class="form-group">
      <label for="price_unit">Unit</label>
      <input type="text" id="price_unit" placeholder="Unit (sqft/piece) Optional">
    </div>

    <div class="form-group">
      <label for="contact_number">Mobile Number *</label>
      <input type="text" id="contact_number" placeholder="Mobile Number" required>
    </div>

    <div class="form-group">
      <label for="email">Email Address *</label>
      <input type="email" id="email" placeholder="Email Address" required>
    </div>

    <div class="form-group">
      <label for="factory_name">Company / Factory Name *</label>
      <input type="text" id="factory_name" placeholder="Company / Factory Name" required>
    </div>

    <div class="form-group">
      <label for="address">Address *</label>
      <input type="text" id="address" placeholder="Address" required>
    </div>

    <div class="form-group">
      <label for="imageInput">Product Images *</label>
      <input type="file" id="imageInput" accept="image/*" multiple required>
      <small style="color:#666;">Select multiple images (max 10)</small>
      <div class="preview" id="preview"></div>
    </div>

    <button type="submit">Save Product</button>
  </form>
</div>

<footer>
  &copy; 2025 Rajasthan SandStone Hub | Designed by RJ Services |
  <a href="about.html">About Us</a> |
  <a href="contact.html">Contact</a>
</footer>

<!-- ===== Sign In Modal ===== -->
<div class="modal" id="signin-modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h2>Sign In</h2>
    <input type="email" id="signin-email" placeholder="Email">
    <input type="password" id="signin-password" placeholder="Password">
    <button id="signin-btn">Sign In</button>
    <div style="text-align:center;margin:10px 0;">OR</div>
    <button id="modal-google-signin" style="background:#4285F4;color:white; display:flex; align-items:center; justify-content:center; gap:8px;">
      <img src="download.png" alt="Google" style="width:20px; height:20px;"> Sign In with Google
    </button>
    <div class="feedback" id="signin-feedback"></div>
    <a href="#" onclick="openModal('signup-modal'); closeModal('signin-modal')">Don't have an account? Sign Up</a>
  </div>
</div>

<!-- ===== Sign Up Modal ===== -->
<div class="modal" id="signup-modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h2>Create Account</h2>
    <input type="text" id="signup-name" placeholder="Full Name">
    <input type="email" id="signup-email" placeholder="Email">
    <input type="password" id="signup-password" placeholder="Password">
    <input type="text" id="signup-phone" placeholder="Phone Number">
    <button id="signup-btn">Sign Up</button>
    <div class="feedback" id="signup-feedback"></div>
    <a href="#" onclick="openModal('signin-modal'); closeModal('signup-modal')">Already have an account? Sign In</a>
  </div>
</div>

<script type="module">
import { auth, db, collection, addDoc, doc, updateDoc, signOut, serverTimestamp, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from './firebase-config.js';

/* ===== Modal Functions ===== */
function openModal(id){ document.getElementById(id).style.display='flex'; }
function closeModal(id){ document.getElementById(id).style.display='none'; }
document.querySelectorAll('.modal-close').forEach(btn=>{ btn.addEventListener('click', ()=>{ btn.closest('.modal').style.display='none'; }); });
document.addEventListener('keydown', (e)=>{ if(e.key === "Escape"){ document.querySelectorAll('.modal').forEach(modal=> modal.style.display='none'); } });

/* ===== Header Buttons & Auth ===== */
const btnOpenSignin = document.getElementById('btn-open-signin');
const btnOpenSignup = document.getElementById('btn-open-signup');
const btnGoogleSignin = document.getElementById('btn-google-signin');
const btnSignOut = document.getElementById('btn-signout');
const historyBtn = document.getElementById('history-btn');

btnOpenSignin.addEventListener('click', ()=>openModal('signin-modal'));
btnOpenSignup.addEventListener('click', ()=>openModal('signup-modal'));

const provider = new GoogleAuthProvider();
document.getElementById('modal-google-signin').addEventListener('click', async ()=>{
  try{ 
    const result = await signInWithPopup(auth, provider); 
    alert(`Signed in as ${result.user.displayName}`); 
    closeModal('signin-modal'); 
  } catch(err){ alert(err.message); }
});

btnGoogleSignin.addEventListener('click', async ()=>{ 
  try{ 
    const result = await signInWithPopup(auth, provider); 
    alert(`Signed in as ${result.user.displayName}`); 
  } catch(err){ alert(err.message); } 
});

btnSignOut.addEventListener('click', async ()=>{ 
  await signOut(auth); 
  alert('Signed out successfully!');
  window.location.href = 'index.html'; // Home page redirect
});

const signinBtn = document.getElementById('signin-btn');
const signinFeedback = document.getElementById('signin-feedback');
signinBtn.addEventListener('click', async ()=>{
  const email = document.getElementById('signin-email').value.trim();
  const password = document.getElementById('signin-password').value.trim();
  signinFeedback.textContent='';
  try{ 
    await signInWithEmailAndPassword(auth,email,password);
    signinFeedback.style.color='green'; 
    signinFeedback.textContent='✅ Signed in successfully!';
    closeModal('signin-modal');
  } catch(err){ 
    signinFeedback.style.color='red'; 
    signinFeedback.textContent='❌ '+err.message; 
  }
});

const signupBtn = document.getElementById('signup-btn');
const signupFeedback = document.getElementById('signup-feedback');
signupBtn.addEventListener('click', async ()=>{
  const name = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const password = document.getElementById('signup-password').value.trim();
  const phone = document.getElementById('signup-phone').value.trim();
  signupFeedback.textContent='';
  try{
    const userCredential = await createUserWithEmailAndPassword(auth,email,password);
    await updateProfile(userCredential.user,{displayName:name,phoneNumber:phone});
    signupFeedback.style.color='green'; 
    signupFeedback.textContent='✅ Account created successfully!';
    closeModal('signup-modal');
  } catch(err){ 
    signupFeedback.style.color='red'; 
    signupFeedback.textContent='❌ '+err.message; 
  }
});

onAuthStateChanged(auth,user=>{
  if(user){
    btnOpenSignin.style.display='none'; 
    btnOpenSignup.style.display='none'; 
    btnGoogleSignin.style.display='none';
    btnSignOut.style.display='inline-block'; 
    historyBtn.style.display='inline-block';
  } else {
    btnOpenSignin.style.display='inline-block'; 
    btnOpenSignup.style.display='inline-block'; 
    btnGoogleSignin.style.display='inline-block';
    btnSignOut.style.display='none'; 
    historyBtn.style.display='none';
  }
});

/* ===== Product Form Logic ===== */
const form = document.getElementById("product-form");
const productIdInput = document.getElementById("product-id");
const preview = document.getElementById("preview");
const imageInput = document.getElementById("imageInput");

/* MULTIPLE IMAGES */
let imagesBase64 = [];

imageInput.addEventListener("change", () => {
  preview.innerHTML = "";
  imagesBase64 = [];

  const files = Array.from(imageInput.files).slice(0, 10);

  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (event) => {
      imagesBase64.push(event.target.result);
      preview.innerHTML += `<img src="${event.target.result}">`;
    };
    reader.readAsDataURL(file);
  });
});

/* CATEGORY AUTO FILL - CORRECTED */
document.getElementById("category").addEventListener("change", function () {
  const selectedCategory = this.value;
  const stoneNameInput = document.getElementById("stone_name");

  if (selectedCategory === "Other Stones") {
    stoneNameInput.value = "";
    stoneNameInput.readOnly = false;
    stoneNameInput.placeholder = "Enter Stone Name";
  } else {
    stoneNameInput.value = selectedCategory;
    stoneNameInput.readOnly = true;
    stoneNameInput.placeholder = "Stone Name";
  }
});

/* IMAGE UPLOAD TO WORKER */
async function uploadImages() {
  let urls = [];

  for (let img of imagesBase64) {
    try {
      const res = await fetch("https://mute-frost-eefa.ravijain236129.workers.dev", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ base64: img })
      });

      const out = await res.json();
      if (out.status === "success") urls.push(out.url);

    } catch (e) {
      console.error("Upload Error:", e);
    }
  }
  return urls;
}

/* EDIT MODE - FOR MY HISTORY PAGE */
window.addEventListener("DOMContentLoaded", () => {
  const editId = localStorage.getItem("editProductId");
  const editData = localStorage.getItem("editProductData");

  if (editId && editData) {
    const p = JSON.parse(decodeURIComponent(editData));

    productIdInput.value = editId;
    form.category.value = p.category || "";

    // Set stone name based on category
    if (p.category === "Other Stones") {
      form.stone_name.readOnly = false;
      form.stone_name.value = p.stone_name || "";
    } else {
      form.stone_name.readOnly = true;
      form.stone_name.value = p.category || "";
    }

    // Fill other fields
    form.sub_category.value = p.sub_category || "";
    form.type.value = p.type || "";
    form.color.value = p.color || "";
    form.description.value = p.description || "";
    form.price.value = p.price || "";
    form.price_unit.value = p.price_unit || "";
    form.contact_number.value = p.contact_number || "";
    form.email.value = p.email || "";
    form.factory_name.value = p.factory_name || "";
    form.address.value = p.address || "";

    // Show existing images
    if (p.images && p.images.length) {
      imagesBase64 = []; // Reset for new uploads
      p.images.forEach(img => {
        preview.innerHTML += `<img src="${img}">`;
        // For edit mode, we keep original images
        imagesBase64.push(img);
      });
    }
  }

  // Clear edit data after loading
  localStorage.removeItem("editProductId");
  localStorage.removeItem("editProductData");
});

/* AUTH CHECK */
onAuthStateChanged(auth, user => {
  if (!user) {
    window.location = "index.html";
  }
});

/* SAVE / UPDATE */
form.onsubmit = async (e) => {
  e.preventDefault();

  const user = auth.currentUser;
  if (!user) return alert("Login required");

  // Upload new images only if new files are selected
  let imageUrls = [];
  if (imagesBase64.length > 0 && typeof imagesBase64[0] === 'string' && imagesBase64[0].startsWith('data:')) {
    imageUrls = await uploadImages();
  } else {
    // If editing and no new images, use existing images
    imageUrls = imagesBase64;
  }

  const data = {
    category: form.category.value,
    stone_name: form.stone_name.value,
    sub_category: form.sub_category.value,
    type: form.type.value,
    color: form.color.value,
    description: form.description.value,
    price: form.price.value ? parseFloat(form.price.value) : "",
    price_unit: form.price_unit.value,
    contact_number: form.contact_number.value,
    email: form.email.value,
    factory_name: form.factory_name.value,
    address: form.address.value,
    images: imageUrls,
    created_at: serverTimestamp(),
    userId: user.uid
  };

  const id = productIdInput.value;

  try {
    if (id) {
      await updateDoc(doc(db, "products", id), data);
      alert("Product updated successfully!");
    } else {
      await addDoc(collection(db, "products"), data);
      alert("Product added successfully!");
    }

    form.reset();
    preview.innerHTML = "";
    imageInput.value = "";
    imagesBase64 = [];
    productIdInput.value = "";

  } catch (err) {
    alert("Error: " + err.message);
  }
};
</script>

</body>
</html>
