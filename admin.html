<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Rajasthan SandStone Hub</title>

<style>
body {font-family:"Poppins",sans-serif;background:#f5f5f5;margin:0;}
header {background:#c7a97b;color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
header h1 {font-size:1.5rem;cursor:pointer;margin:0;}
header button {padding:8px 15px;background:white;color:#c7a97b;border:none;border-radius:6px;font-weight:600;cursor:pointer;}
nav {display:flex;gap:15px;justify-content:center;background:#eee;padding:10px;flex-wrap:wrap;}
nav a {text-decoration:none;font-weight:600;color:#333;}
.container {padding:20px;max-width:1100px;margin:auto;}
form {background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
input,select,textarea {width:100%;padding:10px;margin-bottom:15px;border-radius:6px;border:1px solid #ccc;}
button {padding:12px 20px;background:#c7a97b;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;}
.preview img {width:120px;border-radius:10px;margin:5px;}
</style>
</head>
<body>

<header>
  <h1 onclick="location.href='index.html'">ðŸª¨ Rajasthan SandStone Hub</h1>
  <div>
    <button onclick="location.href='index.html'">Home</button>
    <button onclick="location.href='history.html'">My History</button>
    <button id="logout-btn">Logout</button>
  </div>
</header>

<nav>
  <a href="sandstone.html">Sand Stone</a>
  <a href="kota.html">Kota Stone</a>
  <a href="granite.html">Granite</a>
  <a href="marble.html">Marble</a>
  <a href="bijoliya.html">Bijoliya</a>
  <a href="dholpur.html">Dholpur</a>
  <a href="tiles.html">Tiles</a>
  <a href="mandana.html">Mandana</a>
  <a href="other-stones.html">Other Stones</a>
  <a href="factories.html">Factories</a>
  <a href="about.html">About Us</a>
  <a href="contact.html">Contact</a>
</nav>

<div class="container">
  <h2 style="text-align:center;">Add / Edit Stone Product</h2>

  <form id="product-form">
    <input type="hidden" id="product-id">

    <!-- SELECT CATEGORY -->
    <select id="category" required>
      <option value="">Select Category</option>
      <option>Sand Stone</option>
      <option>Kota Stone</option>
      <option>Granite</option>
      <option>Marble</option>
      <option>Bijoliya</option>
      <option>Dholpur</option>
      <option>Tiles</option>
      <option>Mandana</option>
      <option>Other Stones</option>
      <option>Other</option>
    </select>

    <!-- AUTO FILL / EDIT -->
    <input type="text" id="stone_name" placeholder="Stone Name" readonly required>

    <input type="text" id="sub_category" placeholder="Sub-category (Optional)">
    <input type="text" id="type" placeholder="Type (Optional)">
    <input type="text" id="color" placeholder="Color (Optional)">
    <textarea id="description" placeholder="Description (Optional)"></textarea>

    <!-- NOW COMPULSORY -->
    <input type="number" id="price" placeholder="Price" required>
    <input type="text" id="price_unit" placeholder="Unit (sqft/piece)" required>

    <input type="text" id="contact_number" placeholder="Mobile Number" required>
    <input type="text" id="factory_name" placeholder="Company / Factory Name" required>
    <input type="text" id="address" placeholder="Address" required>

    <!-- MULTIPLE IMAGES -->
    <input type="file" id="imageInput" accept="image/*" multiple required>
    <div id="preview" class="preview"></div>

    <button type="submit">Save Product</button>
  </form>
</div>

<script type="module">
import { auth, db, collection, addDoc, updateDoc, doc, signOut, serverTimestamp }
from "./firebase-config.js";

const form = document.getElementById("product-form");
const preview = document.getElementById("preview");
const imageInput = document.getElementById("imageInput");

let imagesBase64 = [];

/* MULTIPLE IMAGE PREVIEW */
imageInput.addEventListener("change", () => {
  preview.innerHTML = "";
  imagesBase64 = [];

  [...imageInput.files].forEach(file => {
    const r = new FileReader();
    r.onload = e => {
      imagesBase64.push(e.target.result);
      preview.innerHTML += `<img src="${e.target.result}">`;
    };
    r.readAsDataURL(file);
  });
});

/* CATEGORY AUTO FILL */
document.getElementById("category").addEventListener("change", function () {
  const val = this.value;
  const nameBox = document.getElementById("stone_name");

  if (val === "Other") {
    nameBox.readOnly = false;
    nameBox.value = "";
  } else {
    nameBox.readOnly = true;
    nameBox.value = val;
  }
});

/* UPLOAD MULTIPLE IMAGES TO CLOUDFLARE */
async function uploadImages() {
  let urls = [];
  for (let img of imagesBase64) {
    try {
      const res = await fetch("https://mute-frost-eefa.ravijain236129.workers.dev", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ base64: img })
      });
      const out = await res.json();
      if (out.status === "success") urls.push(out.url);
    } catch (e) {
      console.log("Upload error:", e);
    }
  }
  return urls;
}

/* EDIT MODE */
window.addEventListener("DOMContentLoaded", () => {
  const id = localStorage.getItem("editProductId");
  const data = localStorage.getItem("editProductData");

  if (id && data) {
    const p = JSON.parse(decodeURIComponent(data));

    document.getElementById("product-id").value = id;

    form.category.value = p.category;
    form.stone_name.value = p.stone_name;

    // â€œOtherâ€ category editing unlock
    if (p.category === "Other") {
      document.getElementById("stone_name").readOnly = false;
    }

    form.sub_category.value = p.sub_category || "";
    form.type.value = p.type || "";
    form.color.value = p.color || "";
    form.description.value = p.description || "";
    form.price.value = p.price || "";
    form.price_unit.value = p.price_unit || "";
    form.contact_number.value = p.contact_number || "";
    form.factory_name.value = p.factory_name || "";
    form.address.value = p.address || "";

    if (p.images) {
      p.images.forEach(img => {
        preview.innerHTML += `<img src="${img}">`;
      });
    }
  }

  localStorage.removeItem("editProductId");
  localStorage.removeItem("editProductData");
});

/* AUTH CHECK */
auth.onAuthStateChanged(user => {
  if (!user) location.href = "signin.html";
});

/* LOGOUT */
document.getElementById("logout-btn").onclick = async () => {
  await signOut(auth);
  alert("Logged out!");
  location.href = "index.html";
};

/* SAVE PRODUCT */
form.onsubmit = async (e) => {
  e.preventDefault();

  const user = auth.currentUser;
  if (!user) return alert("Login required");

  const images = await uploadImages();

  const data = {
    category: form.category.value,
    stone_name: form.stone_name.value,
    sub_category: form.sub_category.value,
    type: form.type.value,
    color: form.color.value,
    description: form.description.value,
    price: parseFloat(form.price.value),
    price_unit: form.price_unit.value,
    contact_number: form.contact_number.value,
    factory_name: form.factory_name.value,
    address: form.address.value,
    images,
    created_at: serverTimestamp(),
    userId: user.uid
  };

  const id = document.getElementById("product-id").value;

  if (id) {
    await updateDoc(doc(db, "products", id), data);
    alert("Updated successfully!");
  } else {
    await addDoc(collection(db, "products"), data);
    alert("Product added!");
  }

  form.reset();
  preview.innerHTML = "";
  imageInput.value = "";
};
</script>

</body>
</html>
