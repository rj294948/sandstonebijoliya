<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Rajasthan SandStone Hub</title>
<link rel="icon" href="stone-icon.png" type="image/png">
<style>
body {font-family: "Poppins", sans-serif; background: #f5f5f5; margin: 0;}
header {
  background: #c7a97b; color: white; padding: 15px 20px;
  display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
}
header h1 {font-size: 1.5rem; cursor: pointer; margin: 0;}
header div {display: flex; flex-wrap: wrap; gap: 10px;}
header button {
  padding: 8px 15px; border: none; background: #fff; color: #c7a97b;
  border-radius: 6px; cursor: pointer; font-weight: 600;
}
.container {max-width: 600px; margin: 30px auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
h2 {text-align: center; color: #444;}
input, select, textarea {
  width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px;
}
button {padding: 10px 15px; background: #c7a97b; color: white; border: none; border-radius: 6px; cursor: pointer;}
button:hover {background: #b68f63;}
footer {background: #333; color: white; text-align: center; padding: 15px; margin-top: 40px;}
</style>
</head>
<body>

<header>
  <h1 onclick="window.location='index.html'">ü™® Rajasthan SandStone Hub</h1>
  <div>
    <button onclick="window.location='index.html'">Home</button>
    <button onclick="window.location='history.html'">My History</button>
    <button id="logout-btn">Logout</button>
  </div>
</header>

<div class="container">
  <h2 id="form-title">Add New Product</h2>
  <form id="product-form">
    <input type="text" id="stone_name" placeholder="Stone Name" required>
    <input type="text" id="category" placeholder="Category (e.g., Bijoliya)" required>
    <input type="text" id="type" placeholder="Type" required>
    <input type="text" id="color" placeholder="Color" required>
    <input type="number" id="price" placeholder="Price" required>
    <input type="text" id="price_unit" placeholder="Price Unit (e.g., sq.ft)" required>
    <input type="text" id="factory_name" placeholder="Factory Name" required>
    <input type="text" id="contact_number" placeholder="Contact Number" required>
    <input type="url" id="image" placeholder="Image URL" required>
    <button type="submit" id="save-btn">Save Product</button>
  </form>
</div>

<footer>
  &copy; 2025 Rajasthan SandStone Hub | Designed by RJ Services
</footer>

<script type="module">
import { 
  auth, db, collection, addDoc, serverTimestamp, signOut, updateDoc, doc 
} from "./firebase-config.js";

const form = document.getElementById("product-form");
const logoutBtn = document.getElementById("logout-btn");
const formTitle = document.getElementById("form-title");
const saveBtn = document.getElementById("save-btn");

// ‚úÖ Logout setup ‚Äî redirect to Home
logoutBtn.onclick = async () => {
  try {
    await signOut(auth);
    alert("You have been logged out successfully!");
    window.location = "index.html";
  } catch (error) {
    console.error("Logout failed:", error);
    alert("Error logging out. Try again.");
  }
};

// ‚úÖ Auth check
auth.onAuthStateChanged((user) => {
  if (!user) window.location = "signin.html";
});

// ‚úÖ Prefill if editing
let editProductId = localStorage.getItem("editProductId");
let editData = localStorage.getItem("editProductData");

if (editProductId && editData) {
  const p = JSON.parse(decodeURIComponent(editData));
  document.getElementById("stone_name").value = p.stone_name;
  document.getElementById("category").value = p.category;
  document.getElementById("type").value = p.type;
  document.getElementById("color").value = p.color;
  document.getElementById("price").value = p.price;
  document.getElementById("price_unit").value = p.price_unit;
  document.getElementById("factory_name").value = p.factory_name;
  document.getElementById("contact_number").value = p.contact_number;
  document.getElementById("image").value = p.image;
  formTitle.textContent = "Edit Product";
  saveBtn.textContent = "Update Product";
}

form.onsubmit = async (e) => {
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) {
    alert("Please login first.");
    return;
  }

  const productData = {
    stone_name: stone_name.value.trim(),
    category: category.value.trim(),
    type: type.value.trim(),
    color: color.value.trim(),
    price: Number(price.value),
    price_unit: price_unit.value.trim(),
    factory_name: factory_name.value.trim(),
    contact_number: contact_number.value.trim(),
    image: image.value.trim(),
    userId: user.uid,
    created_at: serverTimestamp()
  };

  try {
    if (editProductId) {
      await updateDoc(doc(db, "products", editProductId), productData);
      alert("‚úÖ Product updated successfully!");
      localStorage.removeItem("editProductId");
      localStorage.removeItem("editProductData");
    } else {
      await addDoc(collection(db, "products"), productData);
      alert("‚úÖ Product added successfully!");
    }
    window.location = "history.html";
  } catch (err) {
    console.error(err);
    alert("‚ùå Failed to save product.");
  }
};
</script>

</body>
</html>
