<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Rajasthan SandStone Hub</title>
<link rel="icon" href="stone-icon.png" type="image/png">
<style>
body {font-family:"Poppins",sans-serif;background:#f5f5f5;margin:0;}
header {background:#c7a97b;color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
header h1 {font-size:1.5rem;cursor:pointer;margin:0;}
header div {display:flex;flex-wrap:wrap;gap:10px;}
header button {padding:8px 15px;border:none;background:#fff;color:#c7a97b;border-radius:6px;cursor:pointer;font-weight:600;}
nav {display:flex;justify-content:center;gap:15px;background:#f3f3f3;padding:10px;flex-wrap:wrap;}
nav a {text-decoration:none;color:#333;font-weight:600;}
.container {padding:20px;max-width:1200px;margin:auto;}
h2 {color:#444;text-align:center;margin-bottom:20px;}
form {background:white;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
input,textarea {width:100%;padding:10px;margin-bottom:15px;border-radius:6px;border:1px solid #ccc;}
button {background:#c7a97b;color:white;font-weight:600;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;}
button:hover {background:#b38c5f;}
.preview {text-align:center;margin-bottom:15px;}
.preview img {width:160px;border-radius:10px;}
footer {background:#333;color:white;text-align:center;padding:15px;margin-top:40px;}
footer a {color:white;text-decoration:none;}
</style>
</head>
<body>

<header>
  <h1 onclick="window.location='index.html'">ü™® Rajasthan SandStone Hub</h1>
  <div>
    <button onclick="window.location='index.html'">Home</button>
    <button onclick="window.location='history.html'">My History</button>
    <button id="logout-btn">Logout</button>
  </div>
</header>

<nav>
  <a href="bijoliya.html">Bijoliya</a>
  <a href="dholpur.html">Dholpur</a>
  <a href="mandana.html">Mandana</a>
  <a href="kota.html">Kota</a>
  <a href="other-stones.html">Other Stones</a>
  <a href="factories.html">Factories</a>
  <a href="about.html">About Us</a>
  <a href="contact.html">Contact</a>
</nav>

<div class="container">
  <h2>Add / Edit Stone Product</h2>
  <form id="product-form">
    <input type="hidden" id="product-id">
    <input type="text" id="stone_name" placeholder="Stone Name" required>
    <input type="text" id="category" placeholder="Category (Bijoliya, Dholpur...)" required>
    <input type="text" id="sub_category" placeholder="Sub-category (Optional)">
    <input type="text" id="type" placeholder="Type (Farsi, Gitti, Poll...)" required>
    <input type="text" id="color" placeholder="Color" required>
    <textarea id="description" placeholder="Description" rows="3"></textarea>
    <input type="number" id="price" placeholder="Price" required>
    <input type="text" id="price_unit" placeholder="Unit (sqft, piece...)" required>
    <input type="text" id="contact_number" placeholder="Contact Number" required>
    <input type="email" id="email" placeholder="Email (optional)">
    <input type="text" id="factory_name" placeholder="Factory/Company Name" required>
    <input type="file" id="imageInput" accept="image/*">
    <div class="preview" id="preview"></div>
    <button type="submit">Save Product</button>
  </form>
</div>

<footer>
  &copy; 2025 Rajasthan SandStone Hub | Designed by RJ Services |
  <a href="about.html">About Us</a> | <a href="contact.html">Contact</a>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

// ‚úÖ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDxNMhU09mINvq_aDLtylBg3FucCK-MzYE",
  authDomain: "sandstonebijoliya-293d2.firebaseapp.com",
  projectId: "sandstonebijoliya-293d2",
  storageBucket: "sandstonebijoliya-293d2.appspot.com", // ‚úÖ Correct bucket
  messagingSenderId: "133756247845",
  appId: "1:133756247845:web:8e769ce2af3db1765484cc",
  measurementId: "G-H7JMX9VNYF"
};

// ‚úÖ Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const form = document.getElementById("product-form");
const logoutBtn = document.getElementById("logout-btn");
const imageInput = document.getElementById("imageInput");
const preview = document.getElementById("preview");
const productIdInput = document.getElementById("product-id");

let selectedFile = null;
let existingImageUrl = "";

// üñºÔ∏è Image Preview
imageInput.addEventListener("change", (e) => {
  selectedFile = e.target.files[0];
  if (selectedFile) {
    const reader = new FileReader();
    reader.onload = (event) => {
      preview.innerHTML = `<img src="${event.target.result}" alt="Preview">`;
    };
    reader.readAsDataURL(selectedFile);
  }
});

// ‚úÖ Logout
logoutBtn.onclick = async () => {
  try {
    await signOut(auth);
    alert("You have been logged out successfully!");
    window.location = 'index.html';
  } catch (error) {
    alert("Logout failed: " + error.message);
  }
};

// ‚úÖ Auth Check
onAuthStateChanged(auth, (user) => {
  if (!user) window.location = "signin.html";
});

// ‚úÖ Save or Update Product
form.onsubmit = async (e) => {
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) return alert("Please login again.");

  const id = productIdInput.value;
  const data = {
    stone_name: form.stone_name.value.trim(),
    category: form.category.value.trim(),
    sub_category: form.sub_category.value.trim(),
    type: form.type.value.trim(),
    color: form.color.value.trim(),
    description: form.description.value.trim(),
    price: parseFloat(form.price.value),
    price_unit: form.price_unit.value.trim(),
    contact_number: form.contact_number.value.trim(),
    email: form.email.value.trim() || "",
    factory_name: form.factory_name.value.trim(),
    created_at: serverTimestamp(),
    userId: user.uid
  };

  try {
    let imageUrl = existingImageUrl;

    // Upload image if new file selected
    if (selectedFile) {
      if (selectedFile.size > 2 * 1024 * 1024) {
        alert("Image size too large. Please upload image under 2MB.");
        return;
      }

      const fileName = `${Date.now()}_${selectedFile.name}`;
      const storageRef = ref(storage, `product_images/${fileName}`);
      const uploadTask = await uploadBytesResumable(storageRef, selectedFile);
      imageUrl = await getDownloadURL(uploadTask.ref);
    }

    data.image = imageUrl;

    if (id) {
      await updateDoc(doc(db, "products", id), data);
      alert("‚úÖ Product updated successfully!");
    } else {
      await addDoc(collection(db, "products"), data);
      alert("‚úÖ Product added successfully!");
    }

    form.reset();
    preview.innerHTML = "";
    selectedFile = null;
    existingImageUrl = "";
  } catch (error) {
    console.error("Error:", error);
    alert("‚ùå Upload failed: " + error.message);
  }
};
</script>

</body>
</html>
