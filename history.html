<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My History - Rajasthan SandStone Hub</title>
<link rel="icon" href="stone-icon.png" type="image/png">
<link rel="stylesheet" href="style.css">
<style>
body {font-family:"Poppins",sans-serif;background:#f5f5f5;margin:0;}
header {background:#c7a97b;color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
header h1 {font-size:1.5rem;cursor:pointer;margin:0;}
header div {display:flex;flex-wrap:wrap;gap:10px;}
header button {padding:8px 15px;border:none;background:#fff;color:#c7a97b;border-radius:6px;cursor:pointer;font-weight:600;}
nav {display:flex;justify-content:center;gap:15px;background:#f3f3f3;padding:10px;flex-wrap:wrap;}
nav a {text-decoration:none;color:#333;font-weight:600;}
.container {padding:20px;max-width:1200px;margin:auto;}
h2 {color:#444;text-align:center;margin-bottom:20px;}
#product-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-top:30px;}
.card {background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:10px;}
.card img {width:100%;height:160px;object-fit:cover;border-radius:6px;}
.card h3 {margin:10px 0 5px;color:#333;}
.card p {margin:2px 0;font-size:0.9rem;color:#555;}
.card .actions {display:flex;justify-content:space-between;margin-top:10px;}
.card .actions button {padding:6px 10px;font-size:0.8rem;border:none;border-radius:4px;cursor:pointer;}
.edit-btn {background:#5cb85c;color:#fff;}
.delete-btn {background:#d9534f;color:#fff;}
footer {background:#333;color:white;text-align:center;padding:15px;margin-top:40px;}
footer a {color:white;text-decoration:none;}
</style>
</head>
<body>

<header>
  <h1 onclick="window.location='index.html'">ü™® Rajasthan SandStone Hub</h1>
  <div>
    <button onclick="window.location='index.html'">Home</button>
    <button onclick="window.location='history.html'">My History</button>
    <button id="logout-btn">Logout</button>
  </div>
</header>

<nav>
  <a href="bijoliya.html">Bijoliya</a>
  <a href="dholpur.html">Dholpur</a>
  <a href="mandana.html">Mandana</a>
  <a href="kota.html">Kota</a>
  <a href="other-stones.html">Other Stones</a>
  <a href="factories.html">Factories</a>
  <a href="about.html">About Us</a>
  <a href="contact.html">Contact</a>
</nav>

<div class="container">
  <h2>My Added Products</h2>
  <div id="product-grid"></div>
</div>

<footer>
  &copy; 2025 Rajasthan SandStone Hub | Designed by RJ Services |
  <a href="about.html">About Us</a> | <a href="contact.html">Contact</a>
</footer>

<script type="module">
import { auth, db, collection, query, getDocs, doc, deleteDoc, signOut, orderBy } from "./firebase-config.js";

const logoutBtn = document.getElementById("logout-btn");
const grid = document.getElementById("product-grid");

logoutBtn.onclick = async () => {
  await signOut(auth);
  window.location = "signin.html";
};

auth.onAuthStateChanged(async (user) => {
  if (!user) window.location = "signin.html";
  else loadUserProducts(user.uid);
});

async function loadUserProducts(uid) {
  const q = query(collection(db, "products"), orderBy("created_at", "desc"));
  const snap = await getDocs(q);
  grid.innerHTML = "";

  snap.forEach((docSnap) => {
    const p = docSnap.data();
    if (p.userId === uid) {
      grid.innerHTML += `
      <div class="card">
        <img src="${p.image}" alt="${p.stone_name}">
        <h3>${p.stone_name}</h3>
        <p><b>${p.category}</b> | ${p.type}</p>
        <p>‚Çπ${p.price}/${p.price_unit}</p>
        <p>${p.color}</p>
        <div class="actions">
          <button class="edit-btn" onclick="editProduct('${docSnap.id}', '${encodeURIComponent(JSON.stringify(p))}')">Edit</button>
          <button class="delete-btn" onclick="deleteProduct('${docSnap.id}')">Delete</button>
        </div>
      </div>`;
    }
  });
}

window.editProduct = (id, pData) => {
  localStorage.setItem("editProductId", id);
  localStorage.setItem("editProductData", pData);
  window.location = "admin.html";
};

window.deleteProduct = async (id) => {
  if (confirm("üóëÔ∏è Delete this product?")) {
    await deleteDoc(doc(db, "products", id));
    alert("Deleted successfully!");
    const user = auth.currentUser;
    if (user) loadUserProducts(user.uid);
  }
};
</script>
</body>
</html>
