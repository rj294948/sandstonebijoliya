<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My History - Rajasthan SandStone Hub</title>
<link rel="icon" href="stone.png" type="image/png">
<link rel="stylesheet" href="style.css">
<style>
/* ===== Modal ===== */
.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000;}
.modal-content {background:white; padding:25px; border-radius:12px; width:350px; position:relative;}
.modal-content h2 {text-align:center; color:#c7a97b; margin-bottom:15px;}
.modal-content input, .modal-content select {width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;}
.modal-content button {width:100%; padding:12px; border:none; background:#c7a97b; color:white; font-weight:600; border-radius:6px; cursor:pointer; margin-top:5px;}
.modal-content button:hover {background:#b38c5f;}
.modal-close {position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; color:#c7a97b;}
.modal a {text-decoration:none; color:#c7a97b; display:block; text-align:center; margin-top:10px;}
.feedback {text-align:center; margin-top:8px; font-weight:600; font-size:0.9rem;}

/* ===== Header ===== */
body {font-family:Arial, sans-serif; background:#f5f5f5; margin:0;}
header {background:#c7a97b; color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;}
header h1 {font-size:1.5rem; cursor:pointer; display:flex; align-items:center; gap:10px; margin:0;}
header h1 img {height:40px; border-radius:5px;}
header div button {margin-left:8px; padding:8px 12px; border:none; background:white; color:#c7a97b; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.9rem;}

/* ===== Navigation ===== */
nav {display:flex; justify-content:center; gap:20px; background:#f3f3f3; padding:12px; flex-wrap:wrap;}
nav a {text-decoration:none; color:#333; font-weight:700; font-size:1.05rem; padding:5px 8px; border-radius:4px; transition:all 0.3s ease;}
nav a:hover {background:#e8e8e8; color:#654321;}

/* ===== Container ===== */
.container {padding:20px; max-width:1200px; margin:auto;}
h2 {color:#444; text-align:center; margin-bottom:20px; font-size:2rem;}

/* ===== Product Grid ===== */
#product-grid {display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:25px; margin-top:30px;}

/* ===== Card Design ===== */
.card {background:white; border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.1); padding:20px; transition:transform 0.3s ease, box-shadow 0.3s ease; border:1px solid #e0e0e0;}
.card:hover {transform:translateY(-5px); box-shadow:0 12px 35px rgba(0,0,0,0.15);}

/* ===== Image Gallery ===== */
.image-gallery {position:relative; margin-bottom:15px;}
.main-image {width:100%; height:200px; object-fit:cover; border-radius:10px; cursor:pointer;}
.thumbnail-container {display:flex; gap:8px; margin-top:10px; justify-content:center; flex-wrap:wrap;}
.thumbnail {width:50px; height:50px; object-fit:cover; border-radius:6px; cursor:pointer; border:2px solid transparent; transition:border 0.3s ease;}
.thumbnail:hover, .thumbnail.active {border:2px solid #c7a97b;}
.image-counter {position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.7); color:white; padding:4px 8px; border-radius:12px; font-size:0.8rem;}

/* ===== Card Content ===== */
.card h3 {margin:15px 0 8px; color:#333; font-size:1.3rem; font-weight:600;}
.card p {margin:6px 0; font-size:0.95rem; color:#555; line-height:1.4;}
.price-tag {background:linear-gradient(135deg, #c7a97b, #b38c5f); color:white; padding:8px 15px; border-radius:20px; font-weight:600; font-size:1.1rem; display:inline-block; margin:10px 0;}

/* ===== Actions ===== */
.actions {display:flex; justify-content:space-between; margin-top:20px; gap:10px;}
.actions button {padding:10px 20px; font-size:0.9rem; border:none; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s ease; flex:1;}
.edit-btn {background:linear-gradient(135deg, #5cb85c, #4cae4c); color:white;}
.edit-btn:hover {background:linear-gradient(135deg, #4cae4c, #449d44); transform:scale(1.05);}
.delete-btn {background:linear-gradient(135deg, #d9534f, #c9302c); color:white;}
.delete-btn:hover {background:linear-gradient(135deg, #c9302c, #ac2925); transform:scale(1.05);}

/* ===== Empty State ===== */
.empty-state {text-align:center; padding:60px 20px; color:#666;}
.empty-state h3 {font-size:1.5rem; margin-bottom:10px; color:#888;}
.empty-state p {font-size:1rem; margin-bottom:20px;}

/* ===== Footer ===== */
footer {background:#333; color:white; text-align:center; padding:20px; margin-top:50px;}
footer a {color:white; text-decoration:none; margin:0 10px;}

/* ===== Image Modal ===== */
#image-modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:2000; padding:20px; box-sizing:border-box;}
#image-modal img {max-width:90%; max-height:80%; border-radius:12px; object-fit:contain;}
#image-modal .close-btn, #image-modal .prev-btn, #image-modal .next-btn {position:absolute; font-size:2rem; color:white; background:rgba(0,0,0,0.4); border:none; padding:10px; border-radius:5px; cursor:pointer;}
#image-modal .close-btn {top:20px; right:20px;}
#image-modal .prev-btn {top:50%; left:20px; transform:translateY(-50%);}
#image-modal .next-btn {top:50%; right:20px; transform:translateY(-50%);}
</style>
</head>
<body>

<header>
  <h1><img src="stone.png" alt="Logo">Rajasthan Stones</h1>
  <div>
    <button id="home-btn" onclick="window.location='index.html'">Home</button>
    <button id="history-btn" style="display:none;">My History</button>
    <button id="btn-open-signin">Sign In</button>
    <button id="btn-open-signup">Sign Up</button>
    <button id="btn-google-signin">Sign In with Gmail</button>
    <button id="btn-signout" style="display:none;">Sign Out</button>
    <button id="btn-post" style="display:none;"><a href="admin.html" style="color:inherit;text-decoration:none;">Post Product</a></button>
  </div>
</header>

<nav>
  <a href="sandstone.html">Sand&nbsp;Stone</a>
  <a href="kota.html">Kota&nbsp;Stone</a>
  <a href="granite.html">Granite</a>
  <a href="marble.html">Marble</a>
  <a href="bijoliya.html">Bijoliya</a>
  <a href="dholpur.html">Dholpur</a>
  <a href="tiles.html">Tiles</a>
  <a href="mandana.html">Mandana</a>
  <a href="other-stones.html">Other&nbsp;Stones</a>
  <a href="factories.html">Factories</a>
  <a href="about.html">About&nbsp;Us</a>
  <a href="contact.html">Contact</a>
  <a href="privacy.html">Privacy&nbsp;Policy</a>
  <a href="terms.html">Terms&nbsp;&amp;&nbsp;Conditions</a>
</nav>

<div class="container">
  <h2>üì¶ My Added Products</h2>
  <div id="product-grid">
    <div class="empty-state">
      <h3>No products added yet</h3>
      <p>Start by adding your first stone product!</p>
      <button onclick="window.location='admin.html'" style="background:#c7a97b; color:white; border:none; padding:12px 25px; border-radius:8px; cursor:pointer; font-weight:600;">
        Add Your First Product
      </button>
    </div>
  </div>
</div>

<footer>
  &copy; 2025 Rajasthan SandStone Hub | Designed by RJ Services |
  <a href="about.html">About Us</a> |
  <a href="contact.html">Contact</a>
</footer>

<!-- ===== Sign In Modal ===== -->
<div class="modal" id="signin-modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h2>Sign In</h2>
    <input type="email" id="signin-email" placeholder="Email">
    <input type="password" id="signin-password" placeholder="Password">
    <button id="signin-btn">Sign In</button>
    <div style="text-align:center;margin:10px 0;">OR</div>
    <button id="modal-google-signin" style="background:#4285F4;color:white; display:flex; align-items:center; justify-content:center; gap:8px;">
      <img src="download.png" alt="Google" style="width:20px; height:20px;"> Sign In with Google
    </button>
    <div class="feedback" id="signin-feedback"></div>
    <a href="#" onclick="openModal('signup-modal'); closeModal('signin-modal')">Don't have an account? Sign Up</a>
  </div>
</div>

<!-- ===== Sign Up Modal ===== -->
<div class="modal" id="signup-modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h2>Create Account</h2>
    <input type="text" id="signup-name" placeholder="Full Name">
    <input type="email" id="signup-email" placeholder="Email">
    <input type="password" id="signup-password" placeholder="Password">
    <input type="text" id="signup-phone" placeholder="Phone Number">
    <button id="signup-btn">Sign Up</button>
    <div class="feedback" id="signup-feedback"></div>
    <a href="#" onclick="openModal('signin-modal'); closeModal('signup-modal')">Already have an account? Sign In</a>
  </div>
</div>

<!-- ===== Image Modal ===== -->
<div id="image-modal">
  <button class="prev-btn">&#10094;</button>
  <img id="modal-img" src="">
  <button class="next-btn">&#10095;</button>
  <button class="close-btn">&times;</button>
</div>

<script type="module">
import { 
  auth, 
  db, 
  googleProvider,
  collection, 
  query, 
  getDocs, 
  doc, 
  deleteDoc, 
  signOut, 
  orderBy,
  signInWithPopup,
  onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  updateProfile
} from "./firebase-config.js";

/* ===== Modal Functions ===== */
function openModal(id){ document.getElementById(id).style.display='flex'; }
function closeModal(id){ document.getElementById(id).style.display='none'; }
document.querySelectorAll('.modal-close').forEach(btn=>{ btn.addEventListener('click', ()=>{ btn.closest('.modal').style.display='none'; }); });
document.addEventListener('keydown', (e)=>{ if(e.key === "Escape"){ document.querySelectorAll('.modal').forEach(modal=> modal.style.display='none'); } });

/* ===== Header Buttons & Auth ===== */
const btnOpenSignin = document.getElementById('btn-open-signin');
const btnOpenSignup = document.getElementById('btn-open-signup');
const btnGoogleSignin = document.getElementById('btn-google-signin');
const btnSignOut = document.getElementById('btn-signout');
const btnPost = document.getElementById('btn-post');
const historyBtn = document.getElementById('history-btn');

btnOpenSignin.addEventListener('click', ()=>openModal('signin-modal'));
btnOpenSignup.addEventListener('click', ()=>openModal('signup-modal'));

document.getElementById('modal-google-signin').addEventListener('click', async ()=>{
  try{ 
    const result = await signInWithPopup(auth, googleProvider); 
    alert(`Signed in as ${result.user.displayName}`); 
    closeModal('signin-modal'); 
  } catch(err){ alert(err.message); }
});

btnGoogleSignin.addEventListener('click', async ()=>{ 
  try{ 
    const result = await signInWithPopup(auth, googleProvider); 
    alert(`Signed in as ${result.user.displayName}`); 
  } catch(err){ alert(err.message); } 
});

btnSignOut.addEventListener('click', async ()=>{ 
  await signOut(auth); 
  alert('Signed out successfully!');
  window.location.href = 'index.html';
});

const signinBtn = document.getElementById('signin-btn');
const signinFeedback = document.getElementById('signin-feedback');
signinBtn.addEventListener('click', async ()=>{
  const email = document.getElementById('signin-email').value.trim();
  const password = document.getElementById('signin-password').value.trim();
  signinFeedback.textContent='';
  try{ 
    await signInWithEmailAndPassword(auth,email,password);
    signinFeedback.style.color='green'; 
    signinFeedback.textContent='‚úÖ Signed in successfully!';
    closeModal('signin-modal');
  } catch(err){ 
    signinFeedback.style.color='red'; 
    signinFeedback.textContent='‚ùå '+err.message; 
  }
});

const signupBtn = document.getElementById('signup-btn');
const signupFeedback = document.getElementById('signup-feedback');
signupBtn.addEventListener('click', async ()=>{
  const name = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const password = document.getElementById('signup-password').value.trim();
  const phone = document.getElementById('signup-phone').value.trim();
  signupFeedback.textContent='';
  try{
    const userCredential = await createUserWithEmailAndPassword(auth,email,password);
    await updateProfile(userCredential.user,{displayName:name,phoneNumber:phone});
    signupFeedback.style.color='green'; 
    signupFeedback.textContent='‚úÖ Account created successfully!';
    closeModal('signup-modal');
  } catch(err){ 
    signupFeedback.style.color='red'; 
    signupFeedback.textContent='‚ùå '+err.message; 
  }
});

onAuthStateChanged(auth,user=>{
  if(user){
    btnOpenSignin.style.display='none'; 
    btnOpenSignup.style.display='none'; 
    btnGoogleSignin.style.display='none';
    btnSignOut.style.display='inline-block'; 
    btnPost.style.display='inline-block';
    historyBtn.style.display='inline-block';
  } else {
    btnOpenSignin.style.display='inline-block'; 
    btnOpenSignup.style.display='inline-block'; 
    btnGoogleSignin.style.display='inline-block';
    btnSignOut.style.display='none'; 
    btnPost.style.display='none';
    historyBtn.style.display='none';
  }
});

/* ===== Product Grid Logic ===== */
const grid = document.getElementById("product-grid");

// ‚úÖ Auth check and data load
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location = "index.html";
  } else {
    await loadUserProducts(user.uid);
  }
});

async function loadUserProducts(uid) {
  const q = query(collection(db, "products"), orderBy("created_at", "desc"));
  const snap = await getDocs(q);
  grid.innerHTML = "";

  let userProducts = 0;

  snap.forEach((docSnap) => {
    const p = docSnap.data();
    if (p.userId === uid) {
      userProducts++;
      const productImages = p.images || [];
      const mainImage = productImages.length > 0 ? productImages[0] : 'stone-placeholder.png';
      
      grid.innerHTML += `
      <div class="card">
        <div class="image-gallery">
          <img src="${mainImage}" alt="${p.stone_name}" class="main-image" 
               onclick="openImageGallery(${userProducts}, '${productImages.join("','")}')">
          ${productImages.length > 1 ? `<div class="image-counter">${productImages.length} photos</div>` : ''}
          
          ${productImages.length > 1 ? `
          <div class="thumbnail-container">
            ${productImages.map((img, index) => `
              <img src="${img}" alt="Thumbnail ${index + 1}" class="thumbnail ${index === 0 ? 'active' : ''}" 
                   onclick="changeMainImage(this, '${mainImage}', ${userProducts})">
            `).join('')}
          </div>
          ` : ''}
        </div>
        
        <h3>${p.stone_name || 'Stone Product'}</h3>
        <p><strong>Category:</strong> ${p.category || 'Not specified'}</p>
        <p><strong>Type:</strong> ${p.type || 'Not specified'}</p>
        <p><strong>Color:</strong> ${p.color || 'Not specified'}</p>
        <p><strong>Company:</strong> ${p.factory_name || 'Not specified'}</p>
        
        ${p.price ? `<div class="price-tag">‚Çπ${p.price} ${p.price_unit ? `per ${p.price_unit}` : ''}</div>` : ''}
        
        <p><strong>Contact:</strong> ${p.contact_number || 'Not specified'}</p>
        <p><strong>Email:</strong> ${p.email || 'Not specified'}</p>
        <p><strong>Address:</strong> ${p.address || 'Not specified'}</p>
        
        ${p.description ? `<p><strong>Description:</strong> ${p.description}</p>` : ''}
        
        <div class="actions">
          <button class="edit-btn" onclick="editProduct('${docSnap.id}', '${encodeURIComponent(JSON.stringify(p))}')">‚úèÔ∏è Edit</button>
          <button class="delete-btn" onclick="deleteProduct('${docSnap.id}')">üóëÔ∏è Delete</button>
        </div>
      </div>`;
    }
  });

  if (userProducts === 0) {
    grid.innerHTML = `
      <div class="empty-state">
        <h3>üì¶ No products added yet</h3>
        <p>Start by adding your first stone product to see it here!</p>
        <button onclick="window.location='admin.html'" style="background:#c7a97b; color:white; border:none; padding:12px 25px; border-radius:8px; cursor:pointer; font-weight:600; font-size:1rem;">
          ‚ûï Add Your First Product
        </button>
      </div>
    `;
  }
}

/* ===== Image Gallery Functions ===== */
window.changeMainImage = (thumbnail, fallbackImage, productIndex) => {
  const mainImage = thumbnail.closest('.image-gallery').querySelector('.main-image');
  mainImage.src = thumbnail.src;
  
  // Update active thumbnail
  thumbnail.closest('.thumbnail-container').querySelectorAll('.thumbnail').forEach(thumb => {
    thumb.classList.remove('active');
  });
  thumbnail.classList.add('active');
};

window.openImageGallery = (productIndex, ...imageUrls) => {
  const images = Array.isArray(imageUrls[0]) ? imageUrls[0] : imageUrls;
  if (images.length === 0) return;
  
  let currentImageIndex = 0;
  const modal = document.getElementById('image-modal');
  const modalImg = document.getElementById('modal-img');
  
  modalImg.src = images[currentImageIndex];
  modal.style.display = 'flex';
  
  // Update navigation buttons
  const prevBtn = modal.querySelector('.prev-btn');
  const nextBtn = modal.querySelector('.next-btn');
  
  const updateButtons = () => {
    prevBtn.style.display = images.length > 1 ? 'block' : 'none';
    nextBtn.style.display = images.length > 1 ? 'block' : 'none';
  };
  
  updateButtons();
  
  prevBtn.onclick = () => {
    currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
    modalImg.src = images[currentImageIndex];
  };
  
  nextBtn.onclick = () => {
    currentImageIndex = (currentImageIndex + 1) % images.length;
    modalImg.src = images[currentImageIndex];
  };
};

// Close image modal
document.querySelector('#image-modal .close-btn').onclick = () => {
  document.getElementById('image-modal').style.display = 'none';
};

document.getElementById('image-modal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('image-modal')) {
    document.getElementById('image-modal').style.display = 'none';
  }
});

/* ===== Product Actions ===== */
window.editProduct = (id, pData) => {
  localStorage.setItem("editProductId", id);
  localStorage.setItem("editProductData", pData);
  window.location = "admin.html";
};

window.deleteProduct = async (id) => {
  if (confirm("üóëÔ∏è Are you sure you want to delete this product? This action cannot be undone.")) {
    try {
      await deleteDoc(doc(db, "products", id));
      alert("‚úÖ Product deleted successfully!");
      const user = auth.currentUser;
      if (user) await loadUserProducts(user.uid);
    } catch (error) {
      alert("‚ùå Error deleting product: " + error.message);
    }
  }
};
</script>
</body>
</html>
